# Working Memory - Flashback Cutscene Project

## Current Focus
Cutscene viewer with Canvas 2D + OPL3 audio playback

## Game Data Version
**PC DOS** - DATA directory contains PC DOS version files
- Separate CMD/POL files (cutscene graphics)
- MIDI music (.MID files)
- INS files (80-byte AdLib instrument patches)
- PRF files (instrument configuration per channel)

## Architecture

### Graphics Pipeline
```
DATA/*.CMD + DATA/*.POL
    ↓ CutsceneLoader → CutsceneParser
Cutscene { shapes, palettes, script }
    ↓ CutscenePlayer
OpcodeInterpreter + Canvas2DRenderer + Graphics
    ↓ ImageData buffer
2D Canvas (256x224 native, CSS scaled)
```

### Audio Pipeline
```
PRF file (channel→instrument mapping)
    ↓ PrfParser
INS files (AdLib patches)
    ↓ InsParser → InsToOpl3
libadlmidi-js (Nuked OPL3)
    ↓ setInstrument() per MIDI channel
MIDI file playback
```

## Key Source Files

| Path | Purpose |
|------|---------|
| `CutscenePlayer.ts` | Main orchestrator (graphics + audio) |
| `MidiPlayer.ts` | OPL3 playback with custom instruments |
| `InsParser.ts` | Parse 80-byte INS files |
| `InsToOpl3.ts` | Convert INS → libadlmidi-js format |
| `PrfParser.ts` | Parse PRF channel config |
| `audioMapping.ts` | Cutscene → PRF filename map |

## INS File Format (80 bytes)
```
Byte 0:     mode (0=melodic, 1=percussion)
Byte 1:     channel number
Bytes 2-27: modulator operator (13 uint16 LE fields)
Bytes 28-53: carrier operator (13 uint16 LE fields)
Bytes 54-73: padding
Byte 74:    modulator wave select (0-7)
Byte 76:    carrier wave select (0-7)
```

## PRF Data Structure
- `instruments[16]` - INS filename per slot
- `adlibNotes[16]` - note offset per slot
- `adlibVelocities[16]` - velocity offset per slot
- `adlibPrograms[16]` - MIDI program mapping
- `hwChannelNum[16]` - hardware channel assignment

## Known Issues

### Audio
- Instruments may be shuffled/misassigned to MIDI channels
- REminiscence maps track→slot directly, libadlmidi uses program changes

### Graphics
- 0.17% pixel difference vs reference (edge rounding)

## Build & Deployment

### Configuration
- **Vite base**: `'./'` (relative paths for subdirectory deployment)
- **Build output**: Project root (not dist/)
- **Source HTML**: `index.src.html` (tracked in git)
- **Built HTML**: `index.html` (generated by build)

### Scripts
- `npm run dev` - Copies `index.src.html` to `index.html`, runs Vite dev server
- `npm run build` - TypeScript compile + Vite build to root

### Path Rules
**All paths must be relative** (no leading `/`) for GitHub Pages subdirectory deployment:
- `./DATA/` not `/DATA/`
- `./src/main.ts` not `/src/main.ts`
- `./assets/` not `/assets/`

### Files for Deployment
- `index.html` (built)
- `assets/` (JS, WASM)
- `DATA/` (game files)
- `flashback-instruments.json`, `flashback.wopl` (from public/)

## Vite Configuration
```ts
base: './',  // Relative paths
build: { outDir: '.', emptyOutDir: false },
optimizeDeps: {
  exclude: ['libadlmidi-js', 'libadlmidi-js/nuked']
}
```
