(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();var dt=Object.defineProperty,rt=n=>{throw TypeError(n)},ut=(n,t,e)=>t in n?dt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,f=(n,t,e)=>ut(n,typeof t!="symbol"?t+"":t,e),H=(n,t,e)=>t.has(n)||rt("Cannot "+e),F=(n,t,e)=>(H(n,t,"read from private field"),e?e.call(n):t.get(n)),Y=(n,t,e)=>t.has(n)?rt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),_=(n,t,e,a)=>(H(n,t,"write to private field"),t.set(n,e),e),w=(n,t,e)=>(H(n,t,"access private method"),e);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(a){if(a.ep)return;a.ep=!0;const s=t(a);fetch(a.href,s)}})();const O=256,D=224,it=240,mt=128,q=(O-it)/2,R=50;class ft{constructor(t,e){f(this,"imageData"),f(this,"pixels"),f(this,"width"),f(this,"height"),f(this,"crx",0),f(this,"cry",0),f(this,"crw",0),f(this,"crh",0),this.width=t,this.height=e,this.imageData=new ImageData(t,e),this.pixels=this.imageData.data,this.crw=t,this.crh=e}getImageData(){return this.imageData}getWidth(){return this.width}getHeight(){return this.height}setClippingRect(t,e,a,s){this.crx=t,this.cry=e,this.crw=a,this.crh=s}clear(t){for(let e=0;e<this.pixels.length;e+=4)this.pixels[e]=t.r,this.pixels[e+1]=t.g,this.pixels[e+2]=t.b,this.pixels[e+3]=255}drawPoint(t,e,a){if(e>=0&&e<this.crw&&a>=0&&a<this.crh){const s=e+this.crx,r=a+this.cry;if(s>=0&&s<this.width&&r>=0&&r<this.height){const i=(r*this.width+s)*4;this.pixels[i]=t.r,this.pixels[i+1]=t.g,this.pixels[i+2]=t.b,this.pixels[i+3]=255}}}getPixel(t,e){const a=t+this.crx,s=e+this.cry;if(a>=0&&a<this.width&&s>=0&&s<this.height){const r=(s*this.width+a)*4;return{r:this.pixels[r],g:this.pixels[r+1],b:this.pixels[r+2]}}return{r:0,g:0,b:0}}drawLine(t,e,a,s,r){let i=1,h=1,l=s-e;l<0&&(i=-1,l=-l);let d=r-a;d<0&&(h=-1,d=-d);let c,p,u,o;l<d?(c=0,p=1,u=l,o=d,h<0&&(p=-1)):(c=1,p=0,u=d,o=l,i<0&&(c=-1));let m=e,y=a;const b=u*2-o*2,S=u*2;let P=u*2-o;if(o>=0)for(this.drawPoint(t,m,y);--o>=0;)P>=0?(m+=i,y+=h,P+=b):(m+=c,y+=p,P+=S),this.drawPoint(t,m,y)}drawPolygon(t,e,a){const s=a.length;if(s<2)return;if(s===2){this.drawLine(t,a[0].x,a[0].y,a[1].x,a[1].y);return}let r=a[0].x,i=a[0].x,h=a[0].y,l=a[0].y,d=0;for(let E=1;E<s;E++){const I=a[E].x,C=a[E].y;I<r&&(r=I),I>i&&(i=I),C<h&&(h=C,d=E),C>l&&(l=C)}if(i<0||r>=this.crw||l<0||h>=this.crh)return;if(l===h){this.drawHorizontalSpan(t,e,h,Math.max(0,r),Math.min(this.crw-1,i));return}const c=16,p=1<<c-1;let u=d,o=d;const m=E=>E===0?s-1:E-1,y=E=>E===s-1?0:E+1;let b=a[u].x<<c,S=a[o].x<<c,P=0,x=0,k=a[u].y,M=a[o].y;const N=(E,I)=>{if(I===0)return 0;let C=E*256;return Math.abs(C>>16)<I?C=((Math.trunc(C/I)|0)<<16>>16)*256:C=(Math.trunc(Math.trunc(C/256)/I)&65535)<<16,C},lt=(E,I)=>{if(I===0)return 0;let C=E*256;return Math.abs(C>>16)<I?C=((Math.trunc(C/I)|0)<<16>>16)*256:C=Math.trunc(Math.trunc(C/256)/I)<<16,C},W=()=>{const E=u;u=m(u);const I=a[E].y,C=a[u].y;if(k=C,C>I){const B=a[E].x,V=a[u].x,z=C-I,X=V-B;b=B<<c,P=N(X,z)}},G=()=>{const E=o;o=y(o);const I=a[E].y,C=a[o].y;if(M=C,C>I){const B=a[E].x,V=a[o].x,z=C-I,X=V-B;S=B<<c,x=lt(X,z)}};W(),G();const ht=Math.max(0,h),ct=Math.min(this.crh-1,l);if(h<0){const E=-h;b+=P*E,S+=x*E}for(let E=ht;E<=ct;E++){for(;E>=k&&u!==o;)W();for(;E>=M&&u!==o;)G();let I=b+p>>c,C=S+p>>c;if(I>C){const B=I;I=C,C=B}I=Math.max(0,I),C=Math.min(this.crw-1,C),I<=C&&this.drawHorizontalSpan(t,e,E,I,C),b+=P,S+=x}}drawHorizontalSpan(t,e,a,s,r){if(a<0||a>=this.crh)return;const i=a+this.cry;if(i<0||i>=this.height)return;const h=Math.max(0,s),l=Math.min(this.crw-1,r);for(let d=h;d<=l;d++){const c=d+this.crx;if(c>=0&&c<this.width){const p=(i*this.width+c)*4;e?(this.pixels[p]=this.pixels[p]+t.r>>1,this.pixels[p+1]=this.pixels[p+1]+t.g>>1,this.pixels[p+2]=this.pixels[p+2]+t.b>>1):(this.pixels[p]=t.r,this.pixels[p+1]=t.g,this.pixels[p+2]=t.b),this.pixels[p+3]=255}}}drawEllipse(t,e,a,s,r,i){if(r<=0||i<=0){this.drawPoint(t,a,s);return}const h=new Map,l=(P,x,k)=>{if(P<0||P>=this.crh)return;const M=h.get(P);M?(M.x1=Math.min(M.x1,x),M.x2=Math.max(M.x2,k)):h.set(P,{x1:x,x2:k})};let d=0,c=i;const p=r*r,u=i*i,o=2*p,m=2*u;let y=0,b=o*c,S=Math.round(u-p*i+.25*p);for(;y<b;){const P=a-d,x=a+d;l(s+c,P,x),l(s-c,P,x),d++,y+=m,S<0?S+=u+y:(c--,b-=o,S+=u+y-b)}for(S=Math.round(u*(d+.5)*(d+.5)+p*(c-1)*(c-1)-p*u);c>=0;){const P=a-d,x=a+d;l(s+c,P,x),l(s-c,P,x),c--,b-=o,S>0?S+=p-b:(d++,y+=m,S+=p-b+y)}for(const[P,x]of h)this.drawHorizontalSpan(t,e,P,x.x1,x.x2)}drawPolygonOutline(t,e){const a=e.length;if(!(a<2)){for(let s=0;s<a-1;s++)this.drawLine(t,e[s].x,e[s].y,e[s+1].x,e[s+1].y);this.drawLine(t,e[a-1].x,e[a-1].y,e[0].x,e[0].y)}}}class j{constructor(){f(this,"graphics"),f(this,"shapes",new Map),f(this,"drawnShapes",[]),f(this,"auxShapes",[]),f(this,"palette",[]),f(this,"clearScreen",1),this.graphics=new ft(O,D)}getImageData(){return this.graphics.getImageData()}setPalette(t){this.palette=t}setClearScreen(t){this.clearScreen=t}getColorForClearScreen(t,e){let a=t&31;return e===0&&(a=a+16&31),this.palette[a]||{r:255,g:0,b:255}}loadShapes(t){this.shapes.clear();for(const e of t)this.shapes.set(e.id,e)}drawShape(t,e,a){if(!this.shapes.get(t)){console.warn(`Shape ${t} not found`);return}const s={shapeId:t,x:e,y:a,scale:1,rotation:0,originX:0,originY:0,clearScreenAtDraw:this.clearScreen};this.drawnShapes.push(s),this.clearScreen!==0&&this.auxShapes.push(s)}drawShapeScale(t,e,a,s,r,i){if(!this.shapes.get(t)){console.warn(`Shape ${t} not found`);return}const h=(s+512)/512,l={shapeId:t,x:e,y:a,scale:h,rotation:0,originX:r,originY:i,clearScreenAtDraw:this.clearScreen};this.drawnShapes.push(l),this.clearScreen!==0&&this.auxShapes.push(l)}drawShapeScaleRotate(t,e,a,s,r,i,h,l,d){if(!this.shapes.get(t)){console.warn(`Shape ${t} not found`);return}const c=(s+512)/512,p=h*Math.PI/180,u={shapeId:t,x:e,y:a,scale:c,rotation:p,originX:r,originY:i,clearScreenAtDraw:this.clearScreen};this.drawnShapes.push(u),this.clearScreen!==0&&this.auxShapes.push(u)}clearDrawnShapes(){this.clearScreen===0?this.drawnShapes=[...this.auxShapes]:(this.drawnShapes=[],this.auxShapes=[])}clearAllShapes(){this.drawnShapes=[],this.auxShapes=[]}updateDrawnShapeColors(){}render(){this.graphics.clear({r:0,g:0,b:0});for(const t of this.drawnShapes){const e=this.shapes.get(t.shapeId);e&&this.renderShape(e,t)}this.drawViewportMask()}renderShape(t,e){const a=e.x+q,s=e.y+R;for(const r of t.primitives){const i=this.getColorForClearScreen(r.color,e.clearScreenAtDraw);switch(r.type){case"polygon":this.renderPolygon(r,i,a,s,e);break;case"ellipse":this.renderEllipse(r,i,a,s,e);break;case"point":this.renderPoint(r,i,a,s,e);break}}}transformPoint(t,e,a,s,r){let i=t,h=e;if(r.scale!==1&&(i=r.originX+(i-r.originX)*r.scale,h=r.originY+(h-r.originY)*r.scale),r.rotation!==0){const l=Math.cos(-r.rotation),d=Math.sin(-r.rotation),c=i-r.originX,p=h-r.originY;i=r.originX+c*l-p*d,h=r.originY+c*d+p*l}return{x:Math.round(i+a),y:Math.round(h+s)}}renderPolygon(t,e,a,s,r){const i=t.offsetX||0,h=t.offsetY||0,l=t.vertices.map(([d,c])=>this.transformPoint(d+i,c+h,a,s,r));if(l.length<2){l.length===1&&this.graphics.drawPoint(e,l[0].x,l[0].y);return}this.graphics.drawPolygon(e,t.hasAlpha,l)}renderEllipse(t,e,a,s,r){const i=t.offsetX||0,h=t.offsetY||0,l=this.transformPoint(t.cx+i,t.cy+h,a,s,r);let d=Math.round(Math.abs(t.rx)*r.scale),c=Math.round(Math.abs(t.ry)*r.scale);this.graphics.drawEllipse(e,t.hasAlpha,l.x,l.y,d,c)}renderPoint(t,e,a,s,r){const i=t.offsetX||0,h=t.offsetY||0,l=this.transformPoint(t.x+i,t.y+h,a,s,r);this.graphics.drawPoint(e,l.x,l.y)}drawViewportMask(){const t={r:0,g:0,b:0};for(let s=0;s<R;s++)for(let r=0;r<O;r++)this.setPixelDirect(r,s,t);const e=R+mt;for(let s=e;s<D;s++)for(let r=0;r<O;r++)this.setPixelDirect(r,s,t);for(let s=R;s<e;s++)for(let r=0;r<q;r++)this.setPixelDirect(r,s,t);const a=q+it;for(let s=R;s<e;s++)for(let r=a;r<O;r++)this.setPixelDirect(r,s,t)}setPixelDirect(t,e,a){if(t>=0&&t<O&&e>=0&&e<D){const s=this.graphics.getImageData().data,r=(e*O+t)*4;s[r]=a.r,s[r+1]=a.g,s[r+2]=a.b,s[r+3]=255}}dispose(){this.shapes.clear(),this.drawnShapes=[],this.auxShapes=[]}}class pt{constructor(t,e){f(this,"cutscene"),f(this,"renderer"),f(this,"state"),f(this,"onFrameChange"),this.cutscene=t,this.renderer=e;const a=this.createEmptyPalette();this.state={currentSubscene:0,currentFrame:0,totalFrames:this.countTotalFrames(),paletteBuffer:a,clearScreen:1,isPlaying:!1},this.renderer.setPalette(this.state.paletteBuffer),this.renderer.setClearScreen(this.state.clearScreen)}createEmptyPalette(){const t=[];for(let e=0;e<32;e++)t.push({r:0,g:0,b:0});return t}countTotalFrames(){let t=0;for(const e of this.cutscene.script.subscenes)t+=e.frames.length;return t}setOnFrameChange(t){this.onFrameChange=t}getState(){return{...this.state}}executeCommand(t){switch(t.op){case"markCurPos":this.renderer.clearDrawnShapes();break;case"refreshScreen":this.state.clearScreen=t.clearMode??0,this.renderer.setClearScreen(this.state.clearScreen),this.state.clearScreen!==0&&this.renderer.clearDrawnShapes();break;case"drawShape":t.shapeId!==void 0&&this.renderer.drawShape(t.shapeId,t.x??0,t.y??0);break;case"drawShapeScale":t.shapeId!==void 0&&this.renderer.drawShapeScale(t.shapeId,t.x??0,t.y??0,t.zoom??0,t.originX??0,t.originY??0);break;case"drawShapeScaleRotate":t.shapeId!==void 0&&this.renderer.drawShapeScaleRotate(t.shapeId,t.x??0,t.y??0,t.zoom??0,t.originX??0,t.originY??0,t.rotationA??0,t.rotationB??180,t.rotationC??90);break;case"setPalette":if(t.paletteNum!==void 0){const e=this.cutscene.palettes;if(t.paletteNum<e.length){const a=e[t.paletteNum],s=(((t.bufferNum??0)^1)&1)*16;for(let r=0;r<16&&r<a.length;r++)this.state.paletteBuffer[s+r]=a[r];this.renderer.setPalette(this.state.paletteBuffer)}}break;case"waitForSync":break;case"copyScreen":break;case"refreshAll":break;case"nop":case"skip3":break;case"drawCaptionText":case"drawTextAtPos":break;case"handleKeys":break;default:console.warn("Unknown opcode:",t.op)}}executeFrame(t){for(const e of t.commands)this.executeCommand(e)}renderCurrentFrame(){var t;const{frame:e}=this.getFrameAt(this.state.currentFrame);e&&(this.executeFrame(e),this.renderer.updateDrawnShapeColors()),(t=this.onFrameChange)==null||t.call(this,this.getState())}getFrameAt(t){let e=t;for(let a=0;a<this.cutscene.script.subscenes.length;a++){const s=this.cutscene.script.subscenes[a];if(e<s.frames.length)return{subscene:a,frame:s.frames[e]};e-=s.frames.length}return{subscene:0,frame:null}}nextFrame(){this.state.currentFrame<this.state.totalFrames-1&&(this.state.currentFrame++,this.renderCurrentFrame())}prevFrame(){this.state.currentFrame>0&&(this.state.currentFrame--,this.rebuildToFrame(this.state.currentFrame))}rebuildToFrame(t){var e;this.state.paletteBuffer=this.createEmptyPalette(),this.state.clearScreen=1,this.renderer.clearAllShapes(),this.renderer.setPalette(this.state.paletteBuffer),this.renderer.setClearScreen(this.state.clearScreen);for(let a=0;a<=t;a++){const{frame:s}=this.getFrameAt(a);if(s)for(const r of s.commands)this.executeCommand(r)}this.renderer.updateDrawnShapeColors(),(e=this.onFrameChange)==null||e.call(this,this.getState())}goToFrame(t){t>=0&&t<this.state.totalFrames&&(this.state.currentFrame=t,this.rebuildToFrame(t))}reset(){this.goToFrame(0)}}var $,A,g,K,L,v,J;let yt=(J=class{constructor(n){Y(this,g),Y(this,$,!1),Y(this,A,new Map),this.ctx=n||null,this.node=null}get audioContext(){return this.ctx}get ready(){return F(this,$)}async init(n,t=null){this.ctx||(this.ctx=new AudioContext({sampleRate:44100})),this.ctx.state==="suspended"&&await this.ctx.resume();let e=null;const a=t||n.replace(".processor.js",".core.wasm"),s=await fetch(a);if(!s.ok)throw new Error(`Failed to fetch WASM: ${s.status}`);return e=await s.arrayBuffer(),await this.ctx.audioWorklet.addModule(n),this.node=new AudioWorkletNode(this.ctx,"adl-midi-processor",{processorOptions:{sampleRate:this.ctx.sampleRate,wasmBinary:e}}),this.node.connect(this.ctx.destination),this.node.port.onmessage=r=>w(this,g,K).call(this,r.data),new Promise((r,i)=>{const h=setTimeout(()=>{i(new Error("Timeout waiting for WASM initialization"))},1e4);w(this,g,L).call(this,"ready",()=>{clearTimeout(h),_(this,$,!0),r()}),w(this,g,L).call(this,"error",l=>{clearTimeout(h),i(new Error(l.message))})})}noteOn(n,t,e){w(this,g,v).call(this,{type:"noteOn",channel:n,note:t,velocity:e})}noteOff(n,t){w(this,g,v).call(this,{type:"noteOff",channel:n,note:t})}pitchBend(n,t){const e=t&127,a=t>>7&127;w(this,g,v).call(this,{type:"pitchBend",channel:n,lsb:e,msb:a})}controlChange(n,t,e){w(this,g,v).call(this,{type:"controlChange",channel:n,controller:t,value:e})}programChange(n,t){w(this,g,v).call(this,{type:"programChange",channel:n,program:t})}resetState(){w(this,g,v).call(this,{type:"resetState"})}panic(){w(this,g,v).call(this,{type:"panic"})}async configure(n){return new Promise(t=>{w(this,g,L).call(this,"configured",()=>t()),w(this,g,v).call(this,{type:"configure",settings:n})})}async loadBank(n){return new Promise((t,e)=>{w(this,g,L).call(this,"bankLoaded",a=>{a.success?t():e(new Error(a.error||"Failed to load bank"))}),w(this,g,v).call(this,{type:"loadBank",data:n})})}async setBank(n){return new Promise((t,e)=>{w(this,g,L).call(this,"bankSet",a=>{a.success?t():e(new Error(`Failed to set bank ${n}`))}),w(this,g,v).call(this,{type:"setBank",bank:n})})}async getInstrument(n={percussive:!1,msb:0,lsb:0},t=0){return new Promise((e,a)=>{w(this,g,L).call(this,"instrumentLoaded",s=>{s.success?e(s.instrument):a(new Error(s.error||"Failed to get instrument"))}),w(this,g,v).call(this,{type:"getInstrument",bankId:n,programNumber:t})})}async setInstrument(n={percussive:!1,msb:0,lsb:0},t,e){return new Promise((a,s)=>{w(this,g,L).call(this,"instrumentSet",r=>{r.success?a():s(new Error(r.error||"Failed to set instrument"))}),w(this,g,v).call(this,{type:"setInstrument",bankId:n,programNumber:t,instrument:e})})}setNumChips(n){w(this,g,v).call(this,{type:"setNumChips",chips:n})}setVolumeModel(n){w(this,g,v).call(this,{type:"setVolumeModel",model:n})}setPercussionMode(n){w(this,g,v).call(this,{type:"setPercMode",enabled:n})}setVibrato(n){w(this,g,v).call(this,{type:"setVibrato",enabled:n})}setTremolo(n){w(this,g,v).call(this,{type:"setTremolo",enabled:n})}async switchEmulator(n){return new Promise((t,e)=>{w(this,g,L).call(this,"emulatorSwitched",a=>{a.success?t():e(new Error(`Failed to switch to emulator ${n}. It may not be available in this build profile.`))}),w(this,g,v).call(this,{type:"switchEmulator",emulator:n})})}async getEmulatorName(){return new Promise(n=>{w(this,g,L).call(this,"emulatorName",t=>{n(t.name)}),w(this,g,v).call(this,{type:"getEmulatorName"})})}async getEmbeddedBanks(){return new Promise(n=>{w(this,g,L).call(this,"embeddedBanks",t=>{n(t.banks)}),w(this,g,v).call(this,{type:"getEmbeddedBanks"})})}reset(){w(this,g,v).call(this,{type:"reset"})}async loadMidi(n){return new Promise((t,e)=>{w(this,g,L).call(this,"midiLoaded",a=>{a.success?t({duration:a.duration}):e(new Error(a.error||"Failed to load MIDI data"))}),w(this,g,v).call(this,{type:"loadMidi",data:n})})}play(){w(this,g,v).call(this,{type:"play"})}stop(){w(this,g,v).call(this,{type:"stop"})}seek(n){w(this,g,v).call(this,{type:"seek",position:n})}setLoop(n){w(this,g,v).call(this,{type:"setLoop",enabled:n})}setTempo(n){w(this,g,v).call(this,{type:"setTempo",tempo:n})}async getPlaybackState(){return new Promise(n=>{w(this,g,L).call(this,"state",t=>{n({position:t.position,duration:t.duration,atEnd:t.atEnd,playMode:t.playMode})}),w(this,g,v).call(this,{type:"getState"})})}onPlaybackState(n){var t;return F(this,A).has("state")||F(this,A).set("state",new Set),(t=F(this,A).get("state"))==null||t.add(n),()=>{var e;(e=F(this,A).get("state"))==null||e.delete(n)}}onPlaybackEnded(n){var t;return F(this,A).has("playbackEnded")||F(this,A).set("playbackEnded",new Set),(t=F(this,A).get("playbackEnded"))==null||t.add(n),()=>{var e;(e=F(this,A).get("playbackEnded"))==null||e.delete(n)}}close(){this.node&&(this.node.disconnect(),this.node=null),_(this,$,!1)}async suspend(){this.ctx&&await this.ctx.suspend()}async resume(){this.ctx&&await this.ctx.resume()}},$=new WeakMap,A=new WeakMap,g=new WeakSet,K=function(n){const t=F(this,A).get(n.type);t&&t.forEach(e=>e(n))},L=function(n,t){var e;F(this,A).has(n)||F(this,A).set(n,new Set);const a=s=>{var r;(r=F(this,A).get(n))==null||r.delete(a),t(s)};(e=F(this,A).get(n))==null||e.add(a)},v=function(n){this.node&&this.node.port.postMessage(n)},J);const gt=new URL(""+new URL(""+new URL("libadlmidi.nuked.processor.js",import.meta.url).href,import.meta.url).href,import.meta.url).href,wt=new URL(""+new URL(""+new URL("libadlmidi.nuked.core.wasm",import.meta.url).href,import.meta.url).href,import.meta.url).href;new URL(""+new URL(""+new URL("libadlmidi.nuked.core.js",import.meta.url).href,import.meta.url).href,import.meta.url).href;class bt extends yt{async init(t,e){return super.init(t||gt,e||wt)}}const Q=30,St=20,T=16;function Ct(n){const t=new DataView(n),e=new Uint8Array(n),a=[];for(let m=0;m<T;m++){const y=m*Q,b=Z(e,y,Q);a.push(b||null)}const s=[];for(let m=0;m<T;m++)s.push(t.getInt16(480+m*2,!0));const r=[];for(let m=0;m<T;m++)r.push(t.getInt16(512+m*2,!0));const i=t.getUint32(544,!0),h=t.getUint16(548,!0),l=Z(e,550,St)||"",d=t.getUint16(570,!0),c=[];for(let m=0;m<T;m++)c.push(t.getUint16(572+m*2,!0));const p=[];for(let m=0;m<T;m++)p.push(t.getUint8(700+m));const u=[];for(let m=0;m<T;m++)u.push(t.getUint8(732+m));const o=n.byteLength>=752?t.getUint32(748,!0):0;return{instruments:a,adlibNotes:s,adlibVelocities:r,timerTicks:i,timerMod:h,midiFilename:l,adlibDoNotesLookup:d,adlibPrograms:c,hwChannelNum:p,loopFlag:u,totalDurationTicks:o}}function Z(n,t,e){let a=t;for(;a<t+e&&n[a]!==0;)a++;if(a===t)return null;const s=n.slice(t,a);return String.fromCharCode(...s).trim()}function Pt(n){if(n.byteLength<80)throw new Error(`INS file too small: ${n.byteLength} bytes (expected 80)`);const t=new DataView(n),e=t.getUint8(0),a=t.getUint8(1),s=tt(t,2),r=tt(t,28),i=t.getUint8(74)&7,h=t.getUint8(76)&7;return{mode:e,channelNum:a,modulatorWaveSelect:i,carrierWaveSelect:h,modulator:s,carrier:r}}function tt(n,t){return{keyScaling:n.getUint16(t+0,!0),frequencyMultiplier:n.getUint16(t+2,!0),feedbackStrength:n.getUint16(t+4,!0),attackRate:n.getUint16(t+6,!0),sustainLevel:n.getUint16(t+8,!0),sustainSound:n.getUint16(t+10,!0)!==0,decayRate:n.getUint16(t+12,!0),releaseRate:n.getUint16(t+14,!0),outputLevel:n.getUint16(t+16,!0),amplitudeVibrato:n.getUint16(t+18,!0)!==0,frequencyVibrato:n.getUint16(t+20,!0)!==0,envelopeScaling:n.getUint16(t+22,!0)!==0,frequencyModulation:n.getUint16(t+24,!0)!==0}}function et(){return{am:!1,vibrato:!1,sustaining:!1,ksr:!1,freqMult:0,keyScaleLevel:0,totalLevel:63,attack:0,decay:0,sustain:0,release:0,waveform:0}}function st(n,t){return{am:n.amplitudeVibrato,vibrato:n.frequencyVibrato,sustaining:n.sustainSound,ksr:n.envelopeScaling,freqMult:n.frequencyMultiplier&15,keyScaleLevel:n.keyScaling&3,totalLevel:n.outputLevel&63,attack:n.attackRate&15,decay:n.decayRate&15,sustain:n.sustainLevel&15,release:n.releaseRate&15,waveform:t&7}}function at(n,t={}){const e=st(n.modulator,n.modulatorWaveSelect),a=st(n.carrier,n.carrierWaveSelect),s=t.noteOffset??0;return{version:0,is4op:!1,isPseudo4op:!1,isBlank:!1,rhythmMode:0,feedback1:n.modulator.feedbackStrength&7,connection1:n.modulator.frequencyModulation?0:1,feedback2:0,connection2:0,noteOffset1:s,noteOffset2:0,velocityOffset:t.velocityOffset??0,secondVoiceDetune:0,percussionKey:0,delayOnMs:0,delayOffMs:0,operators:[e,a,et(),et()]}}const U={AUTO:0,GENERIC:1,NATIVE_OPL3:2,DMX:3,APOGEE:4,SB16_9X:5,DMX_FIXED:6,APOGEE_FIXED:7};class Et{constructor(t={}){f(this,"synth",null),f(this,"basePath"),f(this,"initialized",!1),f(this,"initializing",!1),f(this,"loaded",!1),f(this,"loadError",null),f(this,"currentPrfName",null),f(this,"pendingLoad",null),f(this,"stateCallback",null),f(this,"channelCallback",null),f(this,"unsubscribePlaybackState",null),f(this,"unsubscribePlaybackEnded",null),f(this,"channelInstruments",new Array(16).fill(null)),f(this,"channelOctaveOffsets",new Array(16).fill(0)),f(this,"mutedChannels",new Set),f(this,"currentPrf",null),f(this,"availableInstruments",[]),this.basePath=t.basePath??"./DATA/"}async init(){if(this.initialized)return!0;if(this.initializing)return!1;this.initializing=!0;try{return this.synth=new bt,await this.synth.init(),this.synth.setVolumeModel(U.NATIVE_OPL3),this.synth.setVibrato(!1),this.synth.setTremolo(!1),this.initialized=!0,this.initializing=!1,!0}catch(t){return console.error("Failed to initialize OPL3 synth:",t),this.loadError="Audio requires user interaction",this.initializing=!1,this.notifyState(),!1}}async ensureInitialized(){return this.initialized?!0:this.init()}async loadPendingMusic(){if(!this.initialized||!this.pendingLoad)return!1;const t=this.pendingLoad;return this.pendingLoad=null,this.loadForCutscene(t)}hasPendingMusic(){return this.pendingLoad!==null}isLoaded(){return this.loaded}async loadForCutscene(t){if(this.stopAndReset(),!this.initialized)return this.pendingLoad=t,this.currentPrfName=t,this.loadError="Click Play to enable audio",this.notifyState(),!1;if(!this.synth)return console.error("Synth is null but initialized is true"),!1;this.loaded=!1,this.loadError=null,this.currentPrfName=t;try{const e=`${this.basePath}${t.toUpperCase()}.PRF`,a=await fetch(e);if(!a.ok)throw new Error(`PRF file not found: ${e}`);const s=await a.arrayBuffer(),r=Ct(s);this.currentPrf=r,this.channelInstruments=[...r.instruments],this.channelOctaveOffsets=new Array(16).fill(0),this.mutedChannels.clear();const i=r.midiFilename.toUpperCase(),h=`${this.basePath}${i}`,l=await fetch(h);if(!l.ok)throw new Error(`MIDI file not found: ${h}`);const d=await l.arrayBuffer();return await this.loadAvailableInstruments(),await this.loadAndInjectInstruments(r),this.notifyChannels(),await this.synth.loadMidi(d),this.loaded=!0,this.setupCallbacks(),this.notifyState(),!0}catch(e){return console.error(`Failed to load music for ${t}:`,e),this.loadError=e instanceof Error?e.message:"Failed to load music",this.currentPrfName=null,this.notifyState(),!1}}async loadAndInjectInstruments(t){const e=new Map;for(let a=0;a<16;a++){const s=t.instruments[a];if(!s)continue;let r=e.get(s);if(!r){const d=await this.loadInsFile(s);if(!d){console.warn(`INS file not found: ${s}`);continue}r=d,e.set(s,r)}const i=(t.adlibNotes[a]||0)+this.channelOctaveOffsets[a]*12,h=t.adlibVelocities[a]||0,l=at(r,{noteOffset:i,velocityOffset:h});try{const d={percussive:r.mode!==0,msb:0,lsb:0};await this.synth.setInstrument(d,a,l)}catch(d){console.warn(`Failed to inject instrument ${s} for slot ${a}:`,d)}}}async loadInsFile(t){const e=[t.toUpperCase()];t.toLowerCase().endsWith("a")&&t.length>1&&e.push(t.toUpperCase().slice(0,-1));for(const a of e){const s=`${this.basePath}${a}.INS`;try{const r=await fetch(s);if(!r.ok)continue;const i=await r.arrayBuffer();if(i.byteLength!==80||new DataView(i).getUint8(0)>1)continue;return Pt(i)}catch{continue}}return null}stopAndReset(){this.synth&&(this.synth.stop(),this.synth.panic(),this.synth.resetState()),this.loaded=!1,this.currentPrfName=null}setupCallbacks(){var t,e;this.synth&&((t=this.unsubscribePlaybackState)==null||t.call(this),(e=this.unsubscribePlaybackEnded)==null||e.call(this),this.unsubscribePlaybackState=this.synth.onPlaybackState(()=>{this.notifyState()}),this.unsubscribePlaybackEnded=this.synth.onPlaybackEnded(()=>{this.notifyState()}))}onStateChange(t){this.stateCallback=t}onChannelChange(t){this.channelCallback=t}getChannels(){return this.channelInstruments.map((t,e)=>({channel:e,instrumentName:t,muted:this.mutedChannels.has(e),octaveOffset:this.channelOctaveOffsets[e]||0}))}getAvailableInstruments(){return this.availableInstruments}muteChannel(t){t<0||t>15||(this.mutedChannels.add(t),this.synth&&this.synth.controlChange(t,7,0),this.notifyChannels())}unmuteChannel(t){t<0||t>15||(this.mutedChannels.delete(t),this.synth&&this.synth.controlChange(t,7,127),this.notifyChannels())}toggleMuteChannel(t){return this.mutedChannels.has(t)?(this.unmuteChannel(t),!1):(this.muteChannel(t),!0)}async loadAvailableInstruments(){const t=new Set;if(this.currentPrf)for(const a of this.currentPrf.instruments)a&&t.add(a.toLowerCase());const e=["elpiano1","elpiano1a","elbass8","hartbeat","hihat4","sdrsyn01","marimba2","kjm","brss1a","flute1","flute1a","brass02","brass3","string2","synth1","piano3","pianobel","harp","keybrd9","orgpedal","acguit1a","acousti","baselc01","drmlog01","guit-sus"];for(const a of e)try{(await fetch(`${this.basePath}${a.toUpperCase()}.INS`,{method:"HEAD"})).ok&&t.add(a.toLowerCase())}catch{}this.availableInstruments=Array.from(t).sort()}async setChannelInstrument(t,e){var a,s;if(t<0||t>15||!this.synth)return!1;try{const r=await this.loadInsFile(e);if(!r)return!1;const i=(((a=this.currentPrf)==null?void 0:a.adlibNotes[t])||0)+this.channelOctaveOffsets[t]*12,h=((s=this.currentPrf)==null?void 0:s.adlibVelocities[t])||0,l=at(r,{noteOffset:i,velocityOffset:h}),d={percussive:r.mode!==0,msb:0,lsb:0};return await this.synth.setInstrument(d,t,l),this.channelInstruments[t]=e.toLowerCase(),this.notifyChannels(),!0}catch{return!1}}async setChannelOctaveOffset(t,e){if(t<0||t>15)return!1;this.channelOctaveOffsets[t]=e;const a=this.channelInstruments[t];return a&&await this.setChannelInstrument(t,a),this.notifyChannels(),!0}notifyChannels(){var t;(t=this.channelCallback)==null||t.call(this,this.getChannels())}async notifyState(){if(!this.stateCallback)return;const t=await this.getState();this.stateCallback(t)}async getState(){if(!this.synth||!this.loaded)return{loaded:!1,playing:!1,position:0,duration:0,error:this.loadError};try{const t=await this.synth.getPlaybackState();return{loaded:!0,playing:t.playMode==="play",position:t.position,duration:t.duration,error:null}}catch{return{loaded:this.loaded,playing:!1,position:0,duration:0,error:this.loadError}}}async isPlaying(){return!this.synth||!this.loaded?!1:(await this.synth.getPlaybackState()).playMode==="play"}play(){this.synth&&this.loaded&&this.synth.play()}stop(){this.synth&&this.synth.stop()}seek(t){this.synth&&this.loaded&&this.synth.seek(t)}seekToFrame(t,e){const a=t/e;this.seek(a)}setLoop(t){this.synth&&this.synth.setLoop(t)}async getPosition(){return!this.synth||!this.loaded?0:(await this.synth.getPlaybackState()).position}async getDuration(){return!this.synth||!this.loaded?0:(await this.synth.getPlaybackState()).duration}getCurrentPrfName(){return this.currentPrfName}setVolumeModel(t){this.synth&&this.synth.setVolumeModel(t)}dispose(){var t,e;(t=this.unsubscribePlaybackState)==null||t.call(this),(e=this.unsubscribePlaybackEnded)==null||e.call(this),this.synth&&(this.synth.stop(),this.synth.panic(),this.synth.close(),this.synth=null),this.initialized=!1,this.loaded=!1,this.currentPrfName=null}noteOn(t,e,a=100){if(!this.synth||!this.loaded){console.warn("Cannot play note: synth not ready or no music loaded");return}this.synth.noteOn(t,e,a)}noteOff(t,e){this.synth&&this.synth.noteOff(t,e,0)}allNotesOff(){this.synth&&this.synth.panic()}}const vt={intro1:"INTROL3",intro2:"INTROL3",debut:"REVEIL3",objet:"OBJET3",carte:"OBJET3",gen:"RECHAGE3",chute:"CHUTEVI3",desinteg:"DESINTE3",holoseq:"HOLO3",pont:"PONT3",asc:"MISSION3",metro:"DONNER3",missions:"MISSION3",memo:"MEMORY3",taxi:"TAXI3",voyage:"VOYAGE3",teleport:"TELEPOR3",lift:"LIFT3",espions:"DONNER3",log:"MISSION3",fin:"END31",genexp:"GENERAT3",over:"GAMEOVE3",serrure:"MISSION3",map:"MISSION3",score:"MISSION3",camera:"CAPTURE3",alimpont:"PONT3",recharge:"RECHARG3",misvalid:"MISVALI3"};function nt(n){const t=n.toLowerCase();return vt[t]??null}class xt{constructor(t){f(this,"canvas"),f(this,"ctx"),f(this,"renderer"),f(this,"interpreter",null),f(this,"container"),f(this,"scale"),f(this,"animationId",null),f(this,"isPlaying",!1),f(this,"frameInterval",1e3/12),f(this,"lastFrameTime",0),f(this,"stateChangeCallback",null),f(this,"midiPlayer"),f(this,"audioEnabled"),f(this,"midiStateCallback",null),f(this,"currentCutsceneName",null),f(this,"animate",a=>{var s,r,i;if(this.isPlaying&&(this.animationId=requestAnimationFrame(this.animate),a-this.lastFrameTime>=this.frameInterval)){this.lastFrameTime=a;const h=(s=this.interpreter)==null?void 0:s.getState();h&&h.currentFrame<h.totalFrames-1?((r=this.interpreter)==null||r.nextFrame(),this.render()):((i=this.interpreter)==null||i.reset(),this.render())}}),this.container=t.container,this.scale=t.displayScale??3,this.audioEnabled=t.enableAudio??!0,this.canvas=document.createElement("canvas"),this.canvas.width=O,this.canvas.height=D,this.canvas.style.width=`${O*this.scale}px`,this.canvas.style.height=`${D*this.scale}px`,this.canvas.style.imageRendering="pixelated";const e=this.canvas.getContext("2d");if(!e)throw new Error("Could not get 2D context");this.ctx=e,this.ctx.imageSmoothingEnabled=!1,this.container.appendChild(this.canvas),this.renderer=new j,this.midiPlayer=new Et({basePath:t.midiBasePath??"./DATA/"}),this.midiPlayer.onStateChange(a=>{var s;(s=this.midiStateCallback)==null||s.call(this,a)})}loadCutscene(t){var e;this.interpreter&&(this.stop(),this.renderer.dispose()),this.midiPlayer.stopAndReset(),(e=this.midiStateCallback)==null||e.call(this,{loaded:!1,playing:!1,position:0,duration:0,error:null}),this.renderer=new j,this.renderer.loadShapes(t.shapes),this.interpreter=new pt(t,this.renderer),this.stateChangeCallback&&this.interpreter.setOnFrameChange(this.stateChangeCallback),this.interpreter.renderCurrentFrame(),this.render(),this.currentCutsceneName=t.name,this.audioEnabled&&t.name&&this.loadMusicForCutscene(t.name)}async initAudioAndLoadMusic(){if(!await this.midiPlayer.ensureInitialized())return!1;if(this.midiPlayer.hasPendingMusic())return this.midiPlayer.loadPendingMusic();if(this.currentCutsceneName){const t=nt(this.currentCutsceneName);if(t&&!this.midiPlayer.isLoaded())return this.midiPlayer.loadForCutscene(t)}return this.midiPlayer.isLoaded()}async loadMusicForCutscene(t){var e,a;const s=nt(t);if(s)try{await this.midiPlayer.loadForCutscene(s)}catch(r){console.error(`Music load failed for ${t}:`,r),(e=this.midiStateCallback)==null||e.call(this,{loaded:!1,playing:!1,position:0,duration:0,error:r instanceof Error?r.message:"Failed to load music"})}else(a=this.midiStateCallback)==null||a.call(this,{loaded:!1,playing:!1,position:0,duration:0,error:null})}onStateChange(t){var e;this.stateChangeCallback=t,(e=this.interpreter)==null||e.setOnFrameChange(t)}onMidiStateChange(t){this.midiStateCallback=t}async getMidiState(){return this.midiPlayer.getState()}hasAudio(){return this.midiPlayer.isLoaded()}getCurrentCutsceneName(){return this.currentCutsceneName}getState(){var t;return((t=this.interpreter)==null?void 0:t.getState())??null}render(){this.renderer.render(),this.ctx.putImageData(this.renderer.getImageData(),0,0)}async play(){this.isPlaying||(this.isPlaying=!0,this.lastFrameTime=performance.now(),this.animationId=requestAnimationFrame(this.animate),this.audioEnabled&&await this.initAudioAndLoadMusic()&&this.midiPlayer.play())}stop(){this.isPlaying=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.audioEnabled&&this.midiPlayer.stop()}async togglePlay(){return this.isPlaying?this.stop():await this.play(),this.isPlaying}nextFrame(){var t;this.stop(),(t=this.interpreter)==null||t.nextFrame(),this.render(),this.syncMidiToFrame()}prevFrame(){var t;this.stop(),(t=this.interpreter)==null||t.prevFrame(),this.render(),this.syncMidiToFrame()}goToFrame(t){var e;this.stop(),(e=this.interpreter)==null||e.goToFrame(t),this.render(),this.syncMidiToFrame()}reset(){var t;this.stop(),(t=this.interpreter)==null||t.reset(),this.render(),this.audioEnabled&&this.midiPlayer.seek(0)}syncMidiToFrame(){var t;if(!this.audioEnabled||!this.midiPlayer.isLoaded())return;const e=(t=this.interpreter)==null?void 0:t.getState();if(e){const a=1e3/this.frameInterval;this.midiPlayer.seekToFrame(e.currentFrame,a)}}getCanvas(){return this.canvas}screenshot(){return this.render(),this.canvas.toDataURL("image/png")}setFPS(t){this.frameInterval=1e3/t}setDisplayScale(t){this.scale=t,this.canvas.style.width=`${O*t}px`,this.canvas.style.height=`${D*t}px`,this.render()}setAudioEnabled(t){this.audioEnabled=t,t?this.isPlaying&&this.midiPlayer.play():this.midiPlayer.stop()}isAudioEnabled(){return this.audioEnabled}setLoop(t){this.midiPlayer.setLoop(t)}setVolumeModel(t){this.midiPlayer.setVolumeModel(t)}onChannelChange(t){this.midiPlayer.onChannelChange(t)}getChannels(){return this.midiPlayer.getChannels()}async ensureAudioInitialized(){return this.initAudioAndLoadMusic()}toggleMuteChannel(t){return this.midiPlayer.toggleMuteChannel(t)}muteChannel(t){this.midiPlayer.muteChannel(t)}unmuteChannel(t){this.midiPlayer.unmuteChannel(t)}getAvailableInstruments(){return this.midiPlayer.getAvailableInstruments()}async setChannelInstrument(t,e){return this.midiPlayer.setChannelInstrument(t,e)}async setChannelOctaveOffset(t,e){return this.midiPlayer.setChannelOctaveOffset(t,e)}noteOn(t,e,a=100){this.midiPlayer.noteOn(t,e,a)}noteOff(t,e){this.midiPlayer.noteOff(t,e)}allNotesOff(){this.midiPlayer.allNotesOff()}dispose(){this.stop(),this.renderer.dispose(),this.midiPlayer.dispose(),this.container.removeChild(this.canvas)}}const It={0:"markCurPos",1:"refreshScreen",2:"waitForSync",3:"drawShape",4:"setPalette",5:"markCurPos",6:"drawCaptionText",7:"nop",8:"skip3",9:"refreshAll",10:"drawShapeScale",11:"drawShapeScaleRotate",12:"copyScreen",13:"drawTextAtPos",14:"handleKeys"};class ot{constructor(t){f(this,"view"),f(this,"data"),f(this,"pos",0),this.view=new DataView(t),this.data=new Uint8Array(t)}get length(){return this.data.length}readUint8(){const t=this.data[this.pos];return this.pos+=1,t}readInt8(){const t=this.data[this.pos];return this.pos+=1,t<128?t:t-256}readBEUint16(){const t=this.view.getUint16(this.pos,!1);return this.pos+=2,t}readBEInt16(){const t=this.view.getInt16(this.pos,!1);return this.pos+=2,t}readBEUint16At(t){return this.view.getUint16(t,!1)}readBEInt16At(t){return this.view.getInt16(t,!1)}readUint8At(t){return this.data[t]}readInt8At(t){const e=this.data[t];return e<128?e:e-256}seek(t){this.pos=t}eof(){return this.pos>=this.data.length}}function kt(n){const t=new ot(n),e=t.readBEUint16(),a=(e+1)*2;let s,r;if(e===0)s=[0],r=1;else{s=[];for(let h=0;h<e;h++)s.push(t.readBEUint16());r=e}const i=[];for(let h=0;h<r;h++){t.seek(a+s[h]);const l=At(t),d=[];let c=[];for(const p of l)p.op==="markCurPos"&&c.length>0&&(d.push({commands:c}),c=[]),c.push(p);c.length>0&&d.push({commands:c}),i.push({id:h,offset:s[h],frames:d})}return{subsceneCount:r,baseOffset:a,subscenes:i}}function At(n){const t=[];for(;!n.eof();){const e=n.readUint8();if(e&128)break;const a=e>>2;if(a>14){console.warn(`Invalid opcode ${a}`);break}const s={op:It[a]??`unknown_${a}`};switch(a){case 1:s.clearMode=n.readUint8();break;case 2:s.frames=n.readUint8();break;case 3:{const r=n.readBEUint16();s.shapeId=r&2047,r&32768?(s.x=n.readBEInt16(),s.y=n.readBEInt16()):(s.x=0,s.y=0);break}case 4:s.paletteNum=n.readUint8(),s.bufferNum=n.readUint8();break;case 6:s.stringId=n.readBEUint16();break;case 8:s.skipped=[n.readUint8(),n.readUint8(),n.readUint8()];break;case 10:{const r=n.readBEUint16();s.shapeId=r&2047,r&32768?(s.x=n.readBEInt16(),s.y=n.readBEInt16()):(s.x=0,s.y=0),s.zoom=n.readBEInt16(),s.originX=n.readUint8(),s.originY=n.readUint8();break}case 11:{const r=n.readBEUint16();s.shapeId=r&2047,r&32768?(s.x=n.readBEInt16(),s.y=n.readBEInt16()):(s.x=0,s.y=0),r&16384?s.zoom=n.readBEInt16():s.zoom=0,s.originX=n.readUint8(),s.originY=n.readUint8(),s.rotationA=n.readBEUint16(),r&8192?s.rotationB=n.readBEUint16():s.rotationB=180,r&4096?s.rotationC=n.readBEUint16():s.rotationC=90;break}case 13:{const r=n.readBEUint16();r!==65535&&(s.stringId=r&4095,s.color=r>>12&15,s.x=n.readInt8()*8,s.y=n.readInt8()*8);break}case 14:{const r=[];for(;;){const i=n.readUint8();if(i===255)break;const h=n.readBEInt16();r.push({keyMask:i,target:h})}s.handlers=r;break}}t.push(s)}return t}function Mt(n){const t=new ot(n);if(t.length<20)throw new Error("POL data too short");const e=t.readBEUint16At(2),a=t.readBEUint16At(6),s=t.readBEUint16At(10),r=t.readBEUint16At(14),i=t.readBEUint16At(18),h=(a-e)/2,l=16*2,d=Math.max(1,Math.floor((s-a)/l)),c=[];for(let u=0;u<d;u++){const o=[],m=a+u*l;for(let y=0;y<16;y++){const b=t.readBEUint16At(m+y*2);o.push({r:(b>>8&15)*17,g:(b>>4&15)*17,b:(b&15)*17})}c.push(o)}const p=[];for(let u=0;u<h;u++)try{const o=Ft(t,u,e,r,s,i);p.push(o)}catch(o){console.warn(`Failed to parse shape ${u}:`,o);break}return{shapes:p,palettes:c}}function Ft(n,t,e,a,s,r){const i=e+t*2,h=n.readBEUint16At(i),l=a+h,d=n.readBEUint16At(l);let c=l+2;const p=[];for(let u=0;u<d;u++){const o=n.readBEUint16At(c);c+=2;const m=(o&32768)!==0,y=(o&16384)!==0,b=o&16383;let S=0,P=0;m&&(S=n.readBEInt16At(c),P=n.readBEInt16At(c+2),c+=4);const x=n.readUint8At(c);c+=1;const k=Lt(n,b,s,r,x,y,S,P);p.push(k)}return{id:t,primitives:p}}function Lt(n,t,e,a,s,r,i,h){const l=e+t*2,d=n.readBEUint16At(l),c=a+d,p=n.readUint8At(c);let u=c+1;const o={color:s,hasAlpha:r,...i!==0||h!==0?{offsetX:i,offsetY:h}:{}};if(p===0){const S=n.readBEInt16At(u),P=n.readBEInt16At(u+2);return{type:"point",...o,x:S,y:P}}if(p&128){const S=n.readBEInt16At(u),P=n.readBEInt16At(u+2),x=n.readBEInt16At(u+4),k=n.readBEInt16At(u+6);return{type:"ellipse",...o,cx:S,cy:P,rx:x,ry:k}}let m=n.readBEInt16At(u),y=n.readBEInt16At(u+2);u+=4;const b=[[m,y]];for(let S=0;S<p;S++){const P=n.readInt8At(u),x=n.readInt8At(u+1);u+=2,m+=P,y+=x,b.push([m,y])}return{type:"polygon",...o,vertices:b}}class Ot{constructor(){f(this,"basePath","")}setBasePath(t){return this.basePath=t,this}load(t,e,a,s){const r=t.toUpperCase(),i=this.basePath+r+".CMD",h=this.basePath+r+".POL";let l=null,d=null,c=0;const p=()=>{if(l&&d)try{const o=this.parse(l,d,r);e(o)}catch(o){s?s(o):console.error("CutsceneLoader: Failed to parse cutscene:",o)}},u=()=>{if(c++,a){const o=new ProgressEvent("progress",{loaded:c,total:2,lengthComputable:!0});a(o)}};fetch(i).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return o.arrayBuffer()}).then(o=>{l=o,u(),p()}).catch(o=>{s?s(o):console.error(`CutsceneLoader: Failed to load ${i}:`,o)}),fetch(h).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return o.arrayBuffer()}).then(o=>{d=o,u(),p()}).catch(o=>{s?s(o):console.error(`CutsceneLoader: Failed to load ${h}:`,o)})}loadAsync(t,e){return new Promise((a,s)=>{this.load(t,a,e,s)})}parse(t,e,a){const s=kt(t),{shapes:r,palettes:i}=Mt(e);return{name:a,shapes:r,palettes:i,script:s}}}const Ut={[U.AUTO]:"Auto",[U.GENERIC]:"Generic (Linear)",[U.NATIVE_OPL3]:"Native OPL3",[U.DMX]:"DMX",[U.APOGEE]:"Apogee",[U.SB16_9X]:"SB16 9X",[U.DMX_FIXED]:"DMX Fixed",[U.APOGEE_FIXED]:"Apogee Fixed"},Bt=new Ot().setBasePath("./DATA/");async function Nt(n){return Bt.loadAsync(n)}document.addEventListener("DOMContentLoaded",async()=>{const n=document.getElementById("canvas-container"),t=document.getElementById("btn-prev"),e=document.getElementById("btn-play"),a=document.getElementById("btn-next"),s=document.getElementById("frame-info"),r=document.getElementById("audio-info"),i=document.getElementById("cutscene-select"),h=document.getElementById("channel-rows");if(!n||!t||!e||!a||!s||!i){console.error("Required DOM elements not found");return}const l=new xt({container:n,displayScale:3,midiBasePath:"./DATA/",enableAudio:!0});l.onStateChange(o=>{s.textContent=`Frame: ${o.currentFrame+1} / ${o.totalFrames}`,e.textContent=o.isPlaying?"⏸ Pause":"▶ Play"}),l.onMidiStateChange(o=>{if(r)if(o.loaded){const m=p(o.position),y=p(o.duration);r.textContent=`OPL3: ${m} / ${y}`,r.classList.remove("no-audio"),r.classList.add("midi")}else r.textContent=o.error||"No audio",r.classList.add("no-audio"),r.classList.remove("midi")});let d=[];function c(o){var m;if(h){d=l.getAvailableInstruments(),h.innerHTML="";for(const y of o){if(!y.instrumentName)continue;const b=document.createElement("div");b.className="channel-row",y.muted&&b.classList.add("muted"),b.dataset.channel=String(y.channel);const S=document.createElement("input");S.type="checkbox",S.checked=!y.muted,S.title="Enable/disable channel",S.addEventListener("change",()=>{S.checked?l.unmuteChannel(y.channel):l.muteChannel(y.channel),b.classList.toggle("muted",!S.checked)});const P=document.createElement("span");P.className="ch-num",P.textContent=String(y.channel);const x=document.createElement("select");x.title="Change instrument";for(const M of d){const N=document.createElement("option");N.value=M,N.textContent=M,M.toLowerCase()===((m=y.instrumentName)==null?void 0:m.toLowerCase())&&(N.selected=!0),x.appendChild(N)}x.addEventListener("change",async()=>{await l.setChannelInstrument(y.channel,x.value)||(x.value=y.instrumentName||"")});const k=document.createElement("input");k.type="number",k.min="-4",k.max="4",k.value=String(y.octaveOffset||0),k.title="Octave offset",k.addEventListener("change",async()=>{const M=parseInt(k.value)||0;await l.setChannelOctaveOffset(y.channel,M)}),b.appendChild(S),b.appendChild(P),b.appendChild(x),b.appendChild(k),h.appendChild(b)}}}function p(o){if(!isFinite(o))return"0:00";const m=Math.floor(o/60),y=Math.floor(o%60);return`${m}:${y.toString().padStart(2,"0")}`}async function u(o){try{s.textContent="Loading...",r&&(r.textContent="Loading audio...",r.classList.add("no-audio"),r.classList.remove("midi"));const m=await Nt(o);let y=0;for(const S of m.script.subscenes)y+=S.frames.length;l.loadCutscene(m);const b=l.getState();b&&(s.textContent=`Frame: ${b.currentFrame+1} / ${b.totalFrames}`)}catch(m){console.error("Failed to load cutscene:",m),s.textContent="Failed to load cutscene data"}}await u(i.value),i.addEventListener("change",async()=>{l.stop(),await l.ensureAudioInitialized(),await u(i.value)}),t.addEventListener("click",()=>{l.prevFrame()}),e.addEventListener("click",async()=>{await l.ensureAudioInitialized();const o=await l.togglePlay();e.textContent=o?"⏸ Pause":"▶ Play"}),a.addEventListener("click",()=>{l.nextFrame()}),document.addEventListener("keydown",async o=>{switch(o.key){case"ArrowLeft":l.prevFrame();break;case"ArrowRight":l.nextFrame();break;case" ":o.preventDefault(),await l.ensureAudioInitialized(),await l.togglePlay();break;case"Home":l.reset();break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":{const m=parseInt(o.key);l.setVolumeModel(m),r&&(r.textContent=`Vol: ${Ut[m]}`);break}}}),l.onChannelChange(o=>{c(o)})});
