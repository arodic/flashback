var dt=Object.defineProperty;var j=i=>{throw TypeError(i)};var ut=(i,t,e)=>t in i?dt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var p=(i,t,e)=>ut(i,typeof t!="symbol"?t+"":t,e),_=(i,t,e)=>t.has(i)||j("Cannot "+e);var O=(i,t,e)=>(_(i,t,"read from private field"),e?e.call(i):t.get(i)),X=(i,t,e)=>t.has(i)?j("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(i):t.set(i,e),H=(i,t,e,s)=>(_(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e),b=(i,t,e)=>(_(i,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}})();const L=256,D=224,it=240,ft=128,W=(L-it)/2,V=50;class pt{constructor(t,e){p(this,"imageData");p(this,"pixels");p(this,"width");p(this,"height");p(this,"crx",0);p(this,"cry",0);p(this,"crw",0);p(this,"crh",0);this.width=t,this.height=e,this.imageData=new ImageData(t,e),this.pixels=this.imageData.data,this.crw=t,this.crh=e}getImageData(){return this.imageData}getWidth(){return this.width}getHeight(){return this.height}setClippingRect(t,e,s,a){this.crx=t,this.cry=e,this.crw=s,this.crh=a}clear(t){for(let e=0;e<this.pixels.length;e+=4)this.pixels[e]=t.r,this.pixels[e+1]=t.g,this.pixels[e+2]=t.b,this.pixels[e+3]=255}drawPoint(t,e,s){if(e>=0&&e<this.crw&&s>=0&&s<this.crh){const a=e+this.crx,n=s+this.cry;if(a>=0&&a<this.width&&n>=0&&n<this.height){const r=(n*this.width+a)*4;this.pixels[r]=t.r,this.pixels[r+1]=t.g,this.pixels[r+2]=t.b,this.pixels[r+3]=255}}}getPixel(t,e){const s=t+this.crx,a=e+this.cry;if(s>=0&&s<this.width&&a>=0&&a<this.height){const n=(a*this.width+s)*4;return{r:this.pixels[n],g:this.pixels[n+1],b:this.pixels[n+2]}}return{r:0,g:0,b:0}}drawLine(t,e,s,a,n){let r=1,h=1,l=a-e;l<0&&(r=-1,l=-l);let c=n-s;c<0&&(h=-1,c=-c);let d,m,u,o;l<c?(d=0,m=1,u=l,o=c,h<0&&(m=-1)):(d=1,m=0,u=c,o=l,r<0&&(d=-1));let f=e,g=s;const w=u*2-o*2,S=u*2;let P=u*2-o;if(o>=0)for(this.drawPoint(t,f,g);--o>=0;)P>=0?(f+=r,g+=h,P+=w):(f+=d,g+=m,P+=S),this.drawPoint(t,f,g)}drawPolygon(t,e,s){const a=s.length;if(a<2)return;if(a===2){this.drawLine(t,s[0].x,s[0].y,s[1].x,s[1].y);return}let n=s[0].x,r=s[0].x,h=s[0].y,l=s[0].y,c=0;for(let x=1;x<a;x++){const k=s[x].x,C=s[x].y;k<n&&(n=k),k>r&&(r=k),C<h&&(h=C,c=x),C>l&&(l=C)}if(r<0||n>=this.crw||l<0||h>=this.crh)return;if(l===h){this.drawHorizontalSpan(t,e,h,Math.max(0,n),Math.min(this.crw-1,r));return}const d=16,m=1<<d-1;let u=c,o=c;const f=x=>x===0?a-1:x-1,g=x=>x===a-1?0:x+1;let w=s[u].x<<d,S=s[o].x<<d,P=0,I=0,M=s[u].y,F=s[o].y;const N=(x,k)=>{if(k===0)return 0;let C=x*256;return Math.abs(C>>16)<k?C=((Math.trunc(C/k)|0)<<16>>16)*256:C=(Math.trunc(Math.trunc(C/256)/k)&65535)<<16,C},lt=(x,k)=>{if(k===0)return 0;let C=x*256;return Math.abs(C>>16)<k?C=((Math.trunc(C/k)|0)<<16>>16)*256:C=Math.trunc(Math.trunc(C/256)/k)<<16,C},q=()=>{const x=u;u=f(u);const k=s[x].y,C=s[u].y;if(M=C,C>k){const B=s[x].x,$=s[u].x,z=C-k,Y=$-B;w=B<<d,P=N(Y,z)}},G=()=>{const x=o;o=g(o);const k=s[x].y,C=s[o].y;if(F=C,C>k){const B=s[x].x,$=s[o].x,z=C-k,Y=$-B;S=B<<d,I=lt(Y,z)}};q(),G();const ht=Math.max(0,h),ct=Math.min(this.crh-1,l);if(h<0){const x=-h;w+=P*x,S+=I*x}for(let x=ht;x<=ct;x++){for(;x>=M&&u!==o;)q();for(;x>=F&&u!==o;)G();let k=w+m>>d,C=S+m>>d;if(k>C){const B=k;k=C,C=B}k=Math.max(0,k),C=Math.min(this.crw-1,C),k<=C&&this.drawHorizontalSpan(t,e,x,k,C),w+=P,S+=I}}drawHorizontalSpan(t,e,s,a,n){if(s<0||s>=this.crh)return;const r=s+this.cry;if(r<0||r>=this.height)return;const h=Math.max(0,a),l=Math.min(this.crw-1,n);for(let c=h;c<=l;c++){const d=c+this.crx;if(d>=0&&d<this.width){const m=(r*this.width+d)*4;e?(this.pixels[m]=this.pixels[m]+t.r>>1,this.pixels[m+1]=this.pixels[m+1]+t.g>>1,this.pixels[m+2]=this.pixels[m+2]+t.b>>1):(this.pixels[m]=t.r,this.pixels[m+1]=t.g,this.pixels[m+2]=t.b),this.pixels[m+3]=255}}}drawEllipse(t,e,s,a,n,r){if(n<=0||r<=0){this.drawPoint(t,s,a);return}const h=new Map,l=(P,I,M)=>{if(P<0||P>=this.crh)return;const F=h.get(P);F?(F.x1=Math.min(F.x1,I),F.x2=Math.max(F.x2,M)):h.set(P,{x1:I,x2:M})};let c=0,d=r;const m=n*n,u=r*r,o=2*m,f=2*u;let g=0,w=o*d,S=Math.round(u-m*r+.25*m);for(;g<w;){const P=s-c,I=s+c;l(a+d,P,I),l(a-d,P,I),c++,g+=f,S<0?S+=u+g:(d--,w-=o,S+=u+g-w)}for(S=Math.round(u*(c+.5)*(c+.5)+m*(d-1)*(d-1)-m*u);d>=0;){const P=s-c,I=s+c;l(a+d,P,I),l(a-d,P,I),d--,w-=o,S>0?S+=m-w:(c++,g+=f,S+=m-w+g)}for(const[P,I]of h)this.drawHorizontalSpan(t,e,P,I.x1,I.x2)}drawPolygonOutline(t,e){const s=e.length;if(!(s<2)){for(let a=0;a<s-1;a++)this.drawLine(t,e[a].x,e[a].y,e[a+1].x,e[a+1].y);this.drawLine(t,e[s-1].x,e[s-1].y,e[0].x,e[0].y)}}}class K{constructor(){p(this,"graphics");p(this,"shapes",new Map);p(this,"drawnShapes",[]);p(this,"auxShapes",[]);p(this,"palette",[]);p(this,"clearScreen",1);this.graphics=new pt(L,D)}getImageData(){return this.graphics.getImageData()}setPalette(t){this.palette=t}setClearScreen(t){this.clearScreen=t}getColorForClearScreen(t,e){let s=t&31;e===0&&(s=s+16&31);const a=this.palette[s];return a||{r:255,g:0,b:255}}loadShapes(t){this.shapes.clear();for(const e of t)this.shapes.set(e.id,e)}drawShape(t,e,s){if(!this.shapes.get(t)){console.warn(`Shape ${t} not found`);return}const n={shapeId:t,x:e,y:s,scale:1,rotation:0,originX:0,originY:0,clearScreenAtDraw:this.clearScreen};this.drawnShapes.push(n),this.clearScreen!==0&&this.auxShapes.push(n)}drawShapeScale(t,e,s,a,n,r){if(!this.shapes.get(t)){console.warn(`Shape ${t} not found`);return}const l=(a+512)/512,c={shapeId:t,x:e,y:s,scale:l,rotation:0,originX:n,originY:r,clearScreenAtDraw:this.clearScreen};this.drawnShapes.push(c),this.clearScreen!==0&&this.auxShapes.push(c)}drawShapeScaleRotate(t,e,s,a,n,r,h,l,c){if(!this.shapes.get(t)){console.warn(`Shape ${t} not found`);return}const m=(a+512)/512,u=h*Math.PI/180,o={shapeId:t,x:e,y:s,scale:m,rotation:u,originX:n,originY:r,clearScreenAtDraw:this.clearScreen};this.drawnShapes.push(o),this.clearScreen!==0&&this.auxShapes.push(o)}clearDrawnShapes(){this.clearScreen===0?this.drawnShapes=[...this.auxShapes]:(this.drawnShapes=[],this.auxShapes=[])}clearAllShapes(){this.drawnShapes=[],this.auxShapes=[]}updateDrawnShapeColors(){}render(){this.graphics.clear({r:0,g:0,b:0});for(const t of this.drawnShapes){const e=this.shapes.get(t.shapeId);e&&this.renderShape(e,t)}this.drawViewportMask()}renderShape(t,e){const s=e.x+W,a=e.y+V;for(const n of t.primitives){const r=this.getColorForClearScreen(n.color,e.clearScreenAtDraw);switch(n.type){case"polygon":this.renderPolygon(n,r,s,a,e);break;case"ellipse":this.renderEllipse(n,r,s,a,e);break;case"point":this.renderPoint(n,r,s,a,e);break}}}transformPoint(t,e,s,a,n){let r=t,h=e;if(n.scale!==1&&(r=n.originX+(r-n.originX)*n.scale,h=n.originY+(h-n.originY)*n.scale),n.rotation!==0){const l=Math.cos(-n.rotation),c=Math.sin(-n.rotation),d=r-n.originX,m=h-n.originY;r=n.originX+d*l-m*c,h=n.originY+d*c+m*l}return{x:Math.round(r+s),y:Math.round(h+a)}}renderPolygon(t,e,s,a,n){const r=t.offsetX||0,h=t.offsetY||0,l=t.vertices.map(([c,d])=>this.transformPoint(c+r,d+h,s,a,n));if(l.length<2){l.length===1&&this.graphics.drawPoint(e,l[0].x,l[0].y);return}this.graphics.drawPolygon(e,t.hasAlpha,l)}renderEllipse(t,e,s,a,n){const r=t.offsetX||0,h=t.offsetY||0,l=this.transformPoint(t.cx+r,t.cy+h,s,a,n);let c=Math.round(Math.abs(t.rx)*n.scale),d=Math.round(Math.abs(t.ry)*n.scale);this.graphics.drawEllipse(e,t.hasAlpha,l.x,l.y,c,d)}renderPoint(t,e,s,a,n){const r=t.offsetX||0,h=t.offsetY||0,l=this.transformPoint(t.x+r,t.y+h,s,a,n);this.graphics.drawPoint(e,l.x,l.y)}drawViewportMask(){const t={r:0,g:0,b:0};for(let a=0;a<V;a++)for(let n=0;n<L;n++)this.setPixelDirect(n,a,t);const e=V+ft;for(let a=e;a<D;a++)for(let n=0;n<L;n++)this.setPixelDirect(n,a,t);for(let a=V;a<e;a++)for(let n=0;n<W;n++)this.setPixelDirect(n,a,t);const s=W+it;for(let a=V;a<e;a++)for(let n=s;n<L;n++)this.setPixelDirect(n,a,t)}setPixelDirect(t,e,s){if(t>=0&&t<L&&e>=0&&e<D){const a=this.graphics.getImageData().data,n=(e*L+t)*4;a[n]=s.r,a[n+1]=s.g,a[n+2]=s.b,a[n+3]=255}}dispose(){this.shapes.clear(),this.drawnShapes=[],this.auxShapes=[]}}class mt{constructor(t,e){p(this,"cutscene");p(this,"renderer");p(this,"state");p(this,"onFrameChange");this.cutscene=t,this.renderer=e;const s=this.createEmptyPalette();this.state={currentSubscene:0,currentFrame:0,totalFrames:this.countTotalFrames(),paletteBuffer:s,clearScreen:1,isPlaying:!1},this.renderer.setPalette(this.state.paletteBuffer),this.renderer.setClearScreen(this.state.clearScreen)}createEmptyPalette(){const t=[];for(let e=0;e<32;e++)t.push({r:0,g:0,b:0});return t}countTotalFrames(){let t=0;for(const e of this.cutscene.script.subscenes)t+=e.frames.length;return t}setOnFrameChange(t){this.onFrameChange=t}getState(){return{...this.state}}executeCommand(t){switch(t.op){case"markCurPos":this.renderer.clearDrawnShapes();break;case"refreshScreen":this.state.clearScreen=t.clearMode??0,this.renderer.setClearScreen(this.state.clearScreen),this.state.clearScreen!==0&&this.renderer.clearDrawnShapes();break;case"drawShape":t.shapeId!==void 0&&this.renderer.drawShape(t.shapeId,t.x??0,t.y??0);break;case"drawShapeScale":t.shapeId!==void 0&&this.renderer.drawShapeScale(t.shapeId,t.x??0,t.y??0,t.zoom??0,t.originX??0,t.originY??0);break;case"drawShapeScaleRotate":t.shapeId!==void 0&&this.renderer.drawShapeScaleRotate(t.shapeId,t.x??0,t.y??0,t.zoom??0,t.originX??0,t.originY??0,t.rotationA??0,t.rotationB??180,t.rotationC??90);break;case"setPalette":if(t.paletteNum!==void 0){const e=this.cutscene.palettes;if(t.paletteNum<e.length){const s=e[t.paletteNum],n=(((t.bufferNum??0)^1)&1)*16;for(let r=0;r<16&&r<s.length;r++)this.state.paletteBuffer[n+r]=s[r];this.renderer.setPalette(this.state.paletteBuffer)}}break;case"waitForSync":break;case"copyScreen":break;case"refreshAll":break;case"nop":case"skip3":break;case"drawCaptionText":case"drawTextAtPos":break;case"handleKeys":break;default:console.warn("Unknown opcode:",t.op)}}executeFrame(t){for(const e of t.commands)this.executeCommand(e)}renderCurrentFrame(){var e;const{frame:t}=this.getFrameAt(this.state.currentFrame);t&&(this.executeFrame(t),this.renderer.updateDrawnShapeColors()),(e=this.onFrameChange)==null||e.call(this,this.getState())}getFrameAt(t){let e=t;for(let s=0;s<this.cutscene.script.subscenes.length;s++){const a=this.cutscene.script.subscenes[s];if(e<a.frames.length)return{subscene:s,frame:a.frames[e]};e-=a.frames.length}return{subscene:0,frame:null}}nextFrame(){this.state.currentFrame<this.state.totalFrames-1&&(this.state.currentFrame++,this.renderCurrentFrame())}prevFrame(){this.state.currentFrame>0&&(this.state.currentFrame--,this.rebuildToFrame(this.state.currentFrame))}rebuildToFrame(t){var e;this.state.paletteBuffer=this.createEmptyPalette(),this.state.clearScreen=1,this.renderer.clearAllShapes(),this.renderer.setPalette(this.state.paletteBuffer),this.renderer.setClearScreen(this.state.clearScreen);for(let s=0;s<=t;s++){const{frame:a}=this.getFrameAt(s);if(a)for(const n of a.commands)this.executeCommand(n)}this.renderer.updateDrawnShapeColors(),(e=this.onFrameChange)==null||e.call(this,this.getState())}goToFrame(t){t>=0&&t<this.state.totalFrames&&(this.state.currentFrame=t,this.rebuildToFrame(t))}reset(){this.goToFrame(0)}}var R,A,y,rt,v,E,at;let yt=(at=class{constructor(t){X(this,y);X(this,R,!1);X(this,A,new Map);this.ctx=t||null,this.node=null}get audioContext(){return this.ctx}get ready(){return O(this,R)}async init(t,e=null){this.ctx||(this.ctx=new AudioContext({sampleRate:44100})),this.ctx.state==="suspended"&&await this.ctx.resume();let s=null;const a=e||t.replace(".processor.js",".core.wasm"),n=await fetch(a);if(!n.ok)throw new Error(`Failed to fetch WASM: ${n.status}`);return s=await n.arrayBuffer(),await this.ctx.audioWorklet.addModule(t),this.node=new AudioWorkletNode(this.ctx,"adl-midi-processor",{processorOptions:{sampleRate:this.ctx.sampleRate,wasmBinary:s}}),this.node.connect(this.ctx.destination),this.node.port.onmessage=r=>b(this,y,rt).call(this,r.data),new Promise((r,h)=>{const l=setTimeout(()=>{h(new Error("Timeout waiting for WASM initialization"))},1e4);b(this,y,v).call(this,"ready",()=>{clearTimeout(l),H(this,R,!0),r()}),b(this,y,v).call(this,"error",c=>{clearTimeout(l),h(new Error(c.message))})})}noteOn(t,e,s){b(this,y,E).call(this,{type:"noteOn",channel:t,note:e,velocity:s})}noteOff(t,e){b(this,y,E).call(this,{type:"noteOff",channel:t,note:e})}pitchBend(t,e){const s=e&127,a=e>>7&127;b(this,y,E).call(this,{type:"pitchBend",channel:t,lsb:s,msb:a})}controlChange(t,e,s){b(this,y,E).call(this,{type:"controlChange",channel:t,controller:e,value:s})}programChange(t,e){b(this,y,E).call(this,{type:"programChange",channel:t,program:e})}resetState(){b(this,y,E).call(this,{type:"resetState"})}panic(){b(this,y,E).call(this,{type:"panic"})}async configure(t){return new Promise(e=>{b(this,y,v).call(this,"configured",()=>e()),b(this,y,E).call(this,{type:"configure",settings:t})})}async loadBank(t){return new Promise((e,s)=>{b(this,y,v).call(this,"bankLoaded",a=>{a.success?e():s(new Error(a.error||"Failed to load bank"))}),b(this,y,E).call(this,{type:"loadBank",data:t})})}async setBank(t){return new Promise((e,s)=>{b(this,y,v).call(this,"bankSet",a=>{a.success?e():s(new Error(`Failed to set bank ${t}`))}),b(this,y,E).call(this,{type:"setBank",bank:t})})}async getInstrument(t={percussive:!1,msb:0,lsb:0},e=0){return new Promise((s,a)=>{b(this,y,v).call(this,"instrumentLoaded",n=>{n.success?s(n.instrument):a(new Error(n.error||"Failed to get instrument"))}),b(this,y,E).call(this,{type:"getInstrument",bankId:t,programNumber:e})})}async setInstrument(t={percussive:!1,msb:0,lsb:0},e,s){return new Promise((a,n)=>{b(this,y,v).call(this,"instrumentSet",r=>{r.success?a():n(new Error(r.error||"Failed to set instrument"))}),b(this,y,E).call(this,{type:"setInstrument",bankId:t,programNumber:e,instrument:s})})}setNumChips(t){b(this,y,E).call(this,{type:"setNumChips",chips:t})}setVolumeModel(t){b(this,y,E).call(this,{type:"setVolumeModel",model:t})}setPercussionMode(t){b(this,y,E).call(this,{type:"setPercMode",enabled:t})}setVibrato(t){b(this,y,E).call(this,{type:"setVibrato",enabled:t})}setTremolo(t){b(this,y,E).call(this,{type:"setTremolo",enabled:t})}async switchEmulator(t){return new Promise((e,s)=>{b(this,y,v).call(this,"emulatorSwitched",a=>{a.success?e():s(new Error(`Failed to switch to emulator ${t}. It may not be available in this build profile.`))}),b(this,y,E).call(this,{type:"switchEmulator",emulator:t})})}async getEmulatorName(){return new Promise(t=>{b(this,y,v).call(this,"emulatorName",e=>{t(e.name)}),b(this,y,E).call(this,{type:"getEmulatorName"})})}async getEmbeddedBanks(){return new Promise(t=>{b(this,y,v).call(this,"embeddedBanks",e=>{t(e.banks)}),b(this,y,E).call(this,{type:"getEmbeddedBanks"})})}reset(){b(this,y,E).call(this,{type:"reset"})}async loadMidi(t){return new Promise((e,s)=>{b(this,y,v).call(this,"midiLoaded",a=>{a.success?e({duration:a.duration}):s(new Error(a.error||"Failed to load MIDI data"))}),b(this,y,E).call(this,{type:"loadMidi",data:t})})}play(){b(this,y,E).call(this,{type:"play"})}stop(){b(this,y,E).call(this,{type:"stop"})}seek(t){b(this,y,E).call(this,{type:"seek",position:t})}setLoop(t){b(this,y,E).call(this,{type:"setLoop",enabled:t})}setTempo(t){b(this,y,E).call(this,{type:"setTempo",tempo:t})}async getPlaybackState(){return new Promise(t=>{b(this,y,v).call(this,"state",e=>{t({position:e.position,duration:e.duration,atEnd:e.atEnd,playMode:e.playMode})}),b(this,y,E).call(this,{type:"getState"})})}onPlaybackState(t){var e;return O(this,A).has("state")||O(this,A).set("state",new Set),(e=O(this,A).get("state"))==null||e.add(t),()=>{var s;(s=O(this,A).get("state"))==null||s.delete(t)}}onPlaybackEnded(t){var e;return O(this,A).has("playbackEnded")||O(this,A).set("playbackEnded",new Set),(e=O(this,A).get("playbackEnded"))==null||e.add(t),()=>{var s;(s=O(this,A).get("playbackEnded"))==null||s.delete(t)}}close(){this.node&&(this.node.disconnect(),this.node=null),H(this,R,!1)}async suspend(){this.ctx&&await this.ctx.suspend()}async resume(){this.ctx&&await this.ctx.resume()}},R=new WeakMap,A=new WeakMap,y=new WeakSet,rt=function(t){const e=O(this,A).get(t.type);e&&e.forEach(s=>s(t))},v=function(t,e){var a;O(this,A).has(t)||O(this,A).set(t,new Set);const s=n=>{var r;(r=O(this,A).get(t))==null||r.delete(s),e(n)};(a=O(this,A).get(t))==null||a.add(s)},E=function(t){this.node&&this.node.port.postMessage(t)},at);const gt=new URL("/assets/libadlmidi.nuked.processor-K-1fpJQv.js",import.meta.url).href,bt=new URL("/assets/libadlmidi.nuked.core-Bp2VRGRN.wasm",import.meta.url).href;new URL("/assets/libadlmidi.nuked.core-B_dt44mT.js",import.meta.url).href;class wt extends yt{async init(t,e){return super.init(t||gt,e||bt)}}const J=30,St=20,T=16;function Ct(i){const t=new DataView(i),e=new Uint8Array(i),s=[];for(let f=0;f<T;f++){const g=f*J,w=Q(e,g,J);s.push(w||null)}const a=[];for(let f=0;f<T;f++)a.push(t.getInt16(480+f*2,!0));const n=[];for(let f=0;f<T;f++)n.push(t.getInt16(512+f*2,!0));const r=t.getUint32(544,!0),h=t.getUint16(548,!0),l=Q(e,550,St)||"",c=t.getUint16(570,!0),d=[];for(let f=0;f<T;f++)d.push(t.getUint16(572+f*2,!0));const m=[];for(let f=0;f<T;f++)m.push(t.getUint8(700+f));const u=[];for(let f=0;f<T;f++)u.push(t.getUint8(732+f));const o=i.byteLength>=752?t.getUint32(748,!0):0;return{instruments:s,adlibNotes:a,adlibVelocities:n,timerTicks:r,timerMod:h,midiFilename:l,adlibDoNotesLookup:c,adlibPrograms:d,hwChannelNum:m,loopFlag:u,totalDurationTicks:o}}function Q(i,t,e){let s=t;for(;s<t+e&&i[s]!==0;)s++;if(s===t)return null;const a=i.slice(t,s);return String.fromCharCode(...a).trim()}function Pt(i){if(i.byteLength<80)throw new Error(`INS file too small: ${i.byteLength} bytes (expected 80)`);const t=new DataView(i),e=t.getUint8(0),s=t.getUint8(1),a=Z(t,2),n=Z(t,28),r=t.getUint8(74)&7,h=t.getUint8(76)&7;return{mode:e,channelNum:s,modulatorWaveSelect:r,carrierWaveSelect:h,modulator:a,carrier:n}}function Z(i,t){return{keyScaling:i.getUint16(t+0,!0),frequencyMultiplier:i.getUint16(t+2,!0),feedbackStrength:i.getUint16(t+4,!0),attackRate:i.getUint16(t+6,!0),sustainLevel:i.getUint16(t+8,!0),sustainSound:i.getUint16(t+10,!0)!==0,decayRate:i.getUint16(t+12,!0),releaseRate:i.getUint16(t+14,!0),outputLevel:i.getUint16(t+16,!0),amplitudeVibrato:i.getUint16(t+18,!0)!==0,frequencyVibrato:i.getUint16(t+20,!0)!==0,envelopeScaling:i.getUint16(t+22,!0)!==0,frequencyModulation:i.getUint16(t+24,!0)!==0}}function tt(){return{am:!1,vibrato:!1,sustaining:!1,ksr:!1,freqMult:0,keyScaleLevel:0,totalLevel:63,attack:0,decay:0,sustain:0,release:0,waveform:0}}function et(i,t){return{am:i.amplitudeVibrato,vibrato:i.frequencyVibrato,sustaining:i.sustainSound,ksr:i.envelopeScaling,freqMult:i.frequencyMultiplier&15,keyScaleLevel:i.keyScaling&3,totalLevel:i.outputLevel&63,attack:i.attackRate&15,decay:i.decayRate&15,sustain:i.sustainLevel&15,release:i.releaseRate&15,waveform:t&7}}function st(i,t={}){const e=et(i.modulator,i.modulatorWaveSelect),s=et(i.carrier,i.carrierWaveSelect),a=t.noteOffset??0;return{version:0,is4op:!1,isPseudo4op:!1,isBlank:!1,rhythmMode:0,feedback1:i.modulator.feedbackStrength&7,connection1:i.modulator.frequencyModulation?0:1,feedback2:0,connection2:0,noteOffset1:a,noteOffset2:0,velocityOffset:t.velocityOffset??0,secondVoiceDetune:0,percussionKey:0,delayOnMs:0,delayOffMs:0,operators:[e,s,tt(),tt()]}}const U={AUTO:0,GENERIC:1,NATIVE_OPL3:2,DMX:3,APOGEE:4,SB16_9X:5,DMX_FIXED:6,APOGEE_FIXED:7};class xt{constructor(t={}){p(this,"synth",null);p(this,"basePath");p(this,"initialized",!1);p(this,"initializing",!1);p(this,"loaded",!1);p(this,"loadError",null);p(this,"currentPrfName",null);p(this,"pendingLoad",null);p(this,"stateCallback",null);p(this,"channelCallback",null);p(this,"unsubscribePlaybackState",null);p(this,"unsubscribePlaybackEnded",null);p(this,"channelInstruments",new Array(16).fill(null));p(this,"channelOctaveOffsets",new Array(16).fill(0));p(this,"mutedChannels",new Set);p(this,"currentPrf",null);p(this,"availableInstruments",[]);this.basePath=t.basePath??"/DATA/"}async init(){if(this.initialized)return!0;if(this.initializing)return!1;this.initializing=!0;try{return this.synth=new wt,await this.synth.init(),this.synth.setVolumeModel(U.NATIVE_OPL3),this.synth.setVibrato(!1),this.synth.setTremolo(!1),this.initialized=!0,this.initializing=!1,!0}catch(t){return console.error("Failed to initialize OPL3 synth:",t),this.loadError="Audio requires user interaction",this.initializing=!1,this.notifyState(),!1}}async ensureInitialized(){return this.initialized?!0:this.init()}async loadPendingMusic(){if(!this.initialized||!this.pendingLoad)return!1;const t=this.pendingLoad;return this.pendingLoad=null,this.loadForCutscene(t)}hasPendingMusic(){return this.pendingLoad!==null}isLoaded(){return this.loaded}async loadForCutscene(t){if(this.stopAndReset(),!this.initialized)return this.pendingLoad=t,this.currentPrfName=t,this.loadError="Click Play to enable audio",this.notifyState(),!1;if(!this.synth)return console.error("Synth is null but initialized is true"),!1;this.loaded=!1,this.loadError=null,this.currentPrfName=t;try{const e=`${this.basePath}${t.toUpperCase()}.PRF`,s=await fetch(e);if(!s.ok)throw new Error(`PRF file not found: ${e}`);const a=await s.arrayBuffer(),n=Ct(a);this.currentPrf=n,this.channelInstruments=[...n.instruments],this.channelOctaveOffsets=new Array(16).fill(0),this.mutedChannels.clear();const r=n.midiFilename.toUpperCase(),h=`${this.basePath}${r}`,l=await fetch(h);if(!l.ok)throw new Error(`MIDI file not found: ${h}`);const c=await l.arrayBuffer();return await this.loadAvailableInstruments(),await this.loadAndInjectInstruments(n),this.notifyChannels(),await this.synth.loadMidi(c),this.loaded=!0,this.setupCallbacks(),this.notifyState(),!0}catch(e){return console.error(`Failed to load music for ${t}:`,e),this.loadError=e instanceof Error?e.message:"Failed to load music",this.currentPrfName=null,this.notifyState(),!1}}async loadAndInjectInstruments(t){const e=new Map;for(let s=0;s<16;s++){const a=t.instruments[s];if(!a)continue;let n=e.get(a);if(!n){const c=await this.loadInsFile(a);if(!c){console.warn(`INS file not found: ${a}`);continue}n=c,e.set(a,n)}const r=(t.adlibNotes[s]||0)+this.channelOctaveOffsets[s]*12,h=t.adlibVelocities[s]||0,l=st(n,{noteOffset:r,velocityOffset:h});try{const c={percussive:n.mode!==0,msb:0,lsb:0};await this.synth.setInstrument(c,s,l)}catch(c){console.warn(`Failed to inject instrument ${a} for slot ${s}:`,c)}}}async loadInsFile(t){const e=[t.toUpperCase()];t.toLowerCase().endsWith("a")&&t.length>1&&e.push(t.toUpperCase().slice(0,-1));for(const s of e){const a=`${this.basePath}${s}.INS`;try{const n=await fetch(a);if(!n.ok)continue;const r=await n.arrayBuffer();if(r.byteLength!==80||new DataView(r).getUint8(0)>1)continue;return Pt(r)}catch{continue}}return null}stopAndReset(){this.synth&&(this.synth.stop(),this.synth.panic(),this.synth.resetState()),this.loaded=!1,this.currentPrfName=null}setupCallbacks(){var t,e;this.synth&&((t=this.unsubscribePlaybackState)==null||t.call(this),(e=this.unsubscribePlaybackEnded)==null||e.call(this),this.unsubscribePlaybackState=this.synth.onPlaybackState(()=>{this.notifyState()}),this.unsubscribePlaybackEnded=this.synth.onPlaybackEnded(()=>{this.notifyState()}))}onStateChange(t){this.stateCallback=t}onChannelChange(t){this.channelCallback=t}getChannels(){return this.channelInstruments.map((t,e)=>({channel:e,instrumentName:t,muted:this.mutedChannels.has(e),octaveOffset:this.channelOctaveOffsets[e]||0}))}getAvailableInstruments(){return this.availableInstruments}muteChannel(t){t<0||t>15||(this.mutedChannels.add(t),this.synth&&this.synth.controlChange(t,7,0),this.notifyChannels())}unmuteChannel(t){t<0||t>15||(this.mutedChannels.delete(t),this.synth&&this.synth.controlChange(t,7,127),this.notifyChannels())}toggleMuteChannel(t){return this.mutedChannels.has(t)?(this.unmuteChannel(t),!1):(this.muteChannel(t),!0)}async loadAvailableInstruments(){const t=new Set;if(this.currentPrf)for(const s of this.currentPrf.instruments)s&&t.add(s.toLowerCase());const e=["elpiano1","elpiano1a","elbass8","hartbeat","hihat4","sdrsyn01","marimba2","kjm","brss1a","flute1","flute1a","brass02","brass3","string2","synth1","piano3","pianobel","harp","keybrd9","orgpedal","acguit1a","acousti","baselc01","drmlog01","guit-sus"];for(const s of e)try{(await fetch(`${this.basePath}${s.toUpperCase()}.INS`,{method:"HEAD"})).ok&&t.add(s.toLowerCase())}catch{}this.availableInstruments=Array.from(t).sort()}async setChannelInstrument(t,e){var s,a;if(t<0||t>15||!this.synth)return!1;try{const n=await this.loadInsFile(e);if(!n)return!1;const r=(((s=this.currentPrf)==null?void 0:s.adlibNotes[t])||0)+this.channelOctaveOffsets[t]*12,h=((a=this.currentPrf)==null?void 0:a.adlibVelocities[t])||0,l=st(n,{noteOffset:r,velocityOffset:h}),c={percussive:n.mode!==0,msb:0,lsb:0};return await this.synth.setInstrument(c,t,l),this.channelInstruments[t]=e.toLowerCase(),this.notifyChannels(),!0}catch{return!1}}async setChannelOctaveOffset(t,e){if(t<0||t>15)return!1;this.channelOctaveOffsets[t]=e;const s=this.channelInstruments[t];return s&&await this.setChannelInstrument(t,s),this.notifyChannels(),!0}notifyChannels(){var t;(t=this.channelCallback)==null||t.call(this,this.getChannels())}async notifyState(){if(!this.stateCallback)return;const t=await this.getState();this.stateCallback(t)}async getState(){if(!this.synth||!this.loaded)return{loaded:!1,playing:!1,position:0,duration:0,error:this.loadError};try{const t=await this.synth.getPlaybackState();return{loaded:!0,playing:t.playMode==="play",position:t.position,duration:t.duration,error:null}}catch{return{loaded:this.loaded,playing:!1,position:0,duration:0,error:this.loadError}}}async isPlaying(){return!this.synth||!this.loaded?!1:(await this.synth.getPlaybackState()).playMode==="play"}play(){this.synth&&this.loaded&&this.synth.play()}stop(){this.synth&&this.synth.stop()}seek(t){this.synth&&this.loaded&&this.synth.seek(t)}seekToFrame(t,e){const s=t/e;this.seek(s)}setLoop(t){this.synth&&this.synth.setLoop(t)}async getPosition(){return!this.synth||!this.loaded?0:(await this.synth.getPlaybackState()).position}async getDuration(){return!this.synth||!this.loaded?0:(await this.synth.getPlaybackState()).duration}getCurrentPrfName(){return this.currentPrfName}setVolumeModel(t){this.synth&&this.synth.setVolumeModel(t)}dispose(){var t,e;(t=this.unsubscribePlaybackState)==null||t.call(this),(e=this.unsubscribePlaybackEnded)==null||e.call(this),this.synth&&(this.synth.stop(),this.synth.panic(),this.synth.close(),this.synth=null),this.initialized=!1,this.loaded=!1,this.currentPrfName=null}noteOn(t,e,s=100){if(!this.synth||!this.loaded){console.warn("Cannot play note: synth not ready or no music loaded");return}this.synth.noteOn(t,e,s)}noteOff(t,e){this.synth&&this.synth.noteOff(t,e,0)}allNotesOff(){this.synth&&this.synth.panic()}}const Et={intro1:"INTROL3",intro2:"INTROL3",debut:"REVEIL3",objet:"OBJET3",carte:"OBJET3",gen:"RECHAGE3",chute:"CHUTEVI3",desinteg:"DESINTE3",holoseq:"HOLO3",pont:"PONT3",asc:"MISSION3",metro:"DONNER3",missions:"MISSION3",memo:"MEMORY3",taxi:"TAXI3",voyage:"VOYAGE3",teleport:"TELEPOR3",lift:"LIFT3",espions:"DONNER3",log:"MISSION3",fin:"END31",genexp:"GENERAT3",over:"GAMEOVE3",serrure:"MISSION3",map:"MISSION3",score:"MISSION3",camera:"CAPTURE3",alimpont:"PONT3",recharge:"RECHARG3",misvalid:"MISVALI3"};function nt(i){const t=i.toLowerCase();return Et[t]??null}class It{constructor(t){p(this,"canvas");p(this,"ctx");p(this,"renderer");p(this,"interpreter",null);p(this,"container");p(this,"scale");p(this,"animationId",null);p(this,"isPlaying",!1);p(this,"frameInterval",1e3/12);p(this,"lastFrameTime",0);p(this,"stateChangeCallback",null);p(this,"midiPlayer");p(this,"audioEnabled");p(this,"midiStateCallback",null);p(this,"currentCutsceneName",null);p(this,"animate",t=>{var e,s,a;if(this.isPlaying&&(this.animationId=requestAnimationFrame(this.animate),t-this.lastFrameTime>=this.frameInterval)){this.lastFrameTime=t;const n=(e=this.interpreter)==null?void 0:e.getState();n&&n.currentFrame<n.totalFrames-1?((s=this.interpreter)==null||s.nextFrame(),this.render()):((a=this.interpreter)==null||a.reset(),this.render())}});this.container=t.container,this.scale=t.displayScale??3,this.audioEnabled=t.enableAudio??!0,this.canvas=document.createElement("canvas"),this.canvas.width=L,this.canvas.height=D,this.canvas.style.width=`${L*this.scale}px`,this.canvas.style.height=`${D*this.scale}px`,this.canvas.style.imageRendering="pixelated";const e=this.canvas.getContext("2d");if(!e)throw new Error("Could not get 2D context");this.ctx=e,this.ctx.imageSmoothingEnabled=!1,this.container.appendChild(this.canvas),this.renderer=new K,this.midiPlayer=new xt({basePath:t.midiBasePath??"/DATA/"}),this.midiPlayer.onStateChange(s=>{var a;(a=this.midiStateCallback)==null||a.call(this,s)})}loadCutscene(t){var e;this.interpreter&&(this.stop(),this.renderer.dispose()),this.midiPlayer.stopAndReset(),(e=this.midiStateCallback)==null||e.call(this,{loaded:!1,playing:!1,position:0,duration:0,error:null}),this.renderer=new K,this.renderer.loadShapes(t.shapes),this.interpreter=new mt(t,this.renderer),this.stateChangeCallback&&this.interpreter.setOnFrameChange(this.stateChangeCallback),this.interpreter.renderCurrentFrame(),this.render(),this.currentCutsceneName=t.name,this.audioEnabled&&t.name&&this.loadMusicForCutscene(t.name)}async initAudioAndLoadMusic(){if(!await this.midiPlayer.ensureInitialized())return!1;if(this.midiPlayer.hasPendingMusic())return this.midiPlayer.loadPendingMusic();if(this.currentCutsceneName){const e=nt(this.currentCutsceneName);if(e&&!this.midiPlayer.isLoaded())return this.midiPlayer.loadForCutscene(e)}return this.midiPlayer.isLoaded()}async loadMusicForCutscene(t){var s,a;const e=nt(t);if(e)try{await this.midiPlayer.loadForCutscene(e)}catch(n){console.error(`Music load failed for ${t}:`,n),(s=this.midiStateCallback)==null||s.call(this,{loaded:!1,playing:!1,position:0,duration:0,error:n instanceof Error?n.message:"Failed to load music"})}else(a=this.midiStateCallback)==null||a.call(this,{loaded:!1,playing:!1,position:0,duration:0,error:null})}onStateChange(t){var e;this.stateChangeCallback=t,(e=this.interpreter)==null||e.setOnFrameChange(t)}onMidiStateChange(t){this.midiStateCallback=t}async getMidiState(){return this.midiPlayer.getState()}hasAudio(){return this.midiPlayer.isLoaded()}getCurrentCutsceneName(){return this.currentCutsceneName}getState(){var t;return((t=this.interpreter)==null?void 0:t.getState())??null}render(){this.renderer.render(),this.ctx.putImageData(this.renderer.getImageData(),0,0)}async play(){this.isPlaying||(this.isPlaying=!0,this.lastFrameTime=performance.now(),this.animationId=requestAnimationFrame(this.animate),this.audioEnabled&&await this.initAudioAndLoadMusic()&&this.midiPlayer.play())}stop(){this.isPlaying=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.audioEnabled&&this.midiPlayer.stop()}async togglePlay(){return this.isPlaying?this.stop():await this.play(),this.isPlaying}nextFrame(){var t;this.stop(),(t=this.interpreter)==null||t.nextFrame(),this.render(),this.syncMidiToFrame()}prevFrame(){var t;this.stop(),(t=this.interpreter)==null||t.prevFrame(),this.render(),this.syncMidiToFrame()}goToFrame(t){var e;this.stop(),(e=this.interpreter)==null||e.goToFrame(t),this.render(),this.syncMidiToFrame()}reset(){var t;this.stop(),(t=this.interpreter)==null||t.reset(),this.render(),this.audioEnabled&&this.midiPlayer.seek(0)}syncMidiToFrame(){var e;if(!this.audioEnabled||!this.midiPlayer.isLoaded())return;const t=(e=this.interpreter)==null?void 0:e.getState();if(t){const s=1e3/this.frameInterval;this.midiPlayer.seekToFrame(t.currentFrame,s)}}getCanvas(){return this.canvas}screenshot(){return this.render(),this.canvas.toDataURL("image/png")}setFPS(t){this.frameInterval=1e3/t}setDisplayScale(t){this.scale=t,this.canvas.style.width=`${L*t}px`,this.canvas.style.height=`${D*t}px`,this.render()}setAudioEnabled(t){this.audioEnabled=t,t?this.isPlaying&&this.midiPlayer.play():this.midiPlayer.stop()}isAudioEnabled(){return this.audioEnabled}setLoop(t){this.midiPlayer.setLoop(t)}setVolumeModel(t){this.midiPlayer.setVolumeModel(t)}onChannelChange(t){this.midiPlayer.onChannelChange(t)}getChannels(){return this.midiPlayer.getChannels()}async ensureAudioInitialized(){return this.initAudioAndLoadMusic()}toggleMuteChannel(t){return this.midiPlayer.toggleMuteChannel(t)}muteChannel(t){this.midiPlayer.muteChannel(t)}unmuteChannel(t){this.midiPlayer.unmuteChannel(t)}getAvailableInstruments(){return this.midiPlayer.getAvailableInstruments()}async setChannelInstrument(t,e){return this.midiPlayer.setChannelInstrument(t,e)}async setChannelOctaveOffset(t,e){return this.midiPlayer.setChannelOctaveOffset(t,e)}noteOn(t,e,s=100){this.midiPlayer.noteOn(t,e,s)}noteOff(t,e){this.midiPlayer.noteOff(t,e)}allNotesOff(){this.midiPlayer.allNotesOff()}dispose(){this.stop(),this.renderer.dispose(),this.midiPlayer.dispose(),this.container.removeChild(this.canvas)}}const kt={0:"markCurPos",1:"refreshScreen",2:"waitForSync",3:"drawShape",4:"setPalette",5:"markCurPos",6:"drawCaptionText",7:"nop",8:"skip3",9:"refreshAll",10:"drawShapeScale",11:"drawShapeScaleRotate",12:"copyScreen",13:"drawTextAtPos",14:"handleKeys"};class ot{constructor(t){p(this,"view");p(this,"data");p(this,"pos",0);this.view=new DataView(t),this.data=new Uint8Array(t)}get length(){return this.data.length}readUint8(){const t=this.data[this.pos];return this.pos+=1,t}readInt8(){const t=this.data[this.pos];return this.pos+=1,t<128?t:t-256}readBEUint16(){const t=this.view.getUint16(this.pos,!1);return this.pos+=2,t}readBEInt16(){const t=this.view.getInt16(this.pos,!1);return this.pos+=2,t}readBEUint16At(t){return this.view.getUint16(t,!1)}readBEInt16At(t){return this.view.getInt16(t,!1)}readUint8At(t){return this.data[t]}readInt8At(t){const e=this.data[t];return e<128?e:e-256}seek(t){this.pos=t}eof(){return this.pos>=this.data.length}}function Mt(i){const t=new ot(i),e=t.readBEUint16(),s=(e+1)*2;let a,n;if(e===0)a=[0],n=1;else{a=[];for(let h=0;h<e;h++)a.push(t.readBEUint16());n=e}const r=[];for(let h=0;h<n;h++){t.seek(s+a[h]);const l=At(t),c=[];let d=[];for(const m of l)m.op==="markCurPos"&&d.length>0&&(c.push({commands:d}),d=[]),d.push(m);d.length>0&&c.push({commands:d}),r.push({id:h,offset:a[h],frames:c})}return{subsceneCount:n,baseOffset:s,subscenes:r}}function At(i){const t=[];for(;!i.eof();){const e=i.readUint8();if(e&128)break;const s=e>>2;if(s>14){console.warn(`Invalid opcode ${s}`);break}const n={op:kt[s]??`unknown_${s}`};switch(s){case 1:n.clearMode=i.readUint8();break;case 2:n.frames=i.readUint8();break;case 3:{const r=i.readBEUint16();n.shapeId=r&2047,r&32768?(n.x=i.readBEInt16(),n.y=i.readBEInt16()):(n.x=0,n.y=0);break}case 4:n.paletteNum=i.readUint8(),n.bufferNum=i.readUint8();break;case 6:n.stringId=i.readBEUint16();break;case 8:n.skipped=[i.readUint8(),i.readUint8(),i.readUint8()];break;case 10:{const r=i.readBEUint16();n.shapeId=r&2047,r&32768?(n.x=i.readBEInt16(),n.y=i.readBEInt16()):(n.x=0,n.y=0),n.zoom=i.readBEInt16(),n.originX=i.readUint8(),n.originY=i.readUint8();break}case 11:{const r=i.readBEUint16();n.shapeId=r&2047,r&32768?(n.x=i.readBEInt16(),n.y=i.readBEInt16()):(n.x=0,n.y=0),r&16384?n.zoom=i.readBEInt16():n.zoom=0,n.originX=i.readUint8(),n.originY=i.readUint8(),n.rotationA=i.readBEUint16(),r&8192?n.rotationB=i.readBEUint16():n.rotationB=180,r&4096?n.rotationC=i.readBEUint16():n.rotationC=90;break}case 13:{const r=i.readBEUint16();r!==65535&&(n.stringId=r&4095,n.color=r>>12&15,n.x=i.readInt8()*8,n.y=i.readInt8()*8);break}case 14:{const r=[];for(;;){const h=i.readUint8();if(h===255)break;const l=i.readBEInt16();r.push({keyMask:h,target:l})}n.handlers=r;break}}t.push(n)}return t}function Ft(i){const t=new ot(i);if(t.length<20)throw new Error("POL data too short");const e=t.readBEUint16At(2),s=t.readBEUint16At(6),a=t.readBEUint16At(10),n=t.readBEUint16At(14),r=t.readBEUint16At(18),h=(s-e)/2,l=16*2,c=Math.max(1,Math.floor((a-s)/l)),d=[];for(let u=0;u<c;u++){const o=[],f=s+u*l;for(let g=0;g<16;g++){const w=t.readBEUint16At(f+g*2);o.push({r:(w>>8&15)*17,g:(w>>4&15)*17,b:(w&15)*17})}d.push(o)}const m=[];for(let u=0;u<h;u++)try{const o=Ot(t,u,e,n,a,r);m.push(o)}catch(o){console.warn(`Failed to parse shape ${u}:`,o);break}return{shapes:m,palettes:d}}function Ot(i,t,e,s,a,n){const r=e+t*2,h=i.readBEUint16At(r),l=s+h,c=i.readBEUint16At(l);let d=l+2;const m=[];for(let u=0;u<c;u++){const o=i.readBEUint16At(d);d+=2;const f=(o&32768)!==0,g=(o&16384)!==0,w=o&16383;let S=0,P=0;f&&(S=i.readBEInt16At(d),P=i.readBEInt16At(d+2),d+=4);const I=i.readUint8At(d);d+=1;const M=vt(i,w,a,n,I,g,S,P);m.push(M)}return{id:t,primitives:m}}function vt(i,t,e,s,a,n,r,h){const l=e+t*2,c=i.readBEUint16At(l),d=s+c,m=i.readUint8At(d);let u=d+1;const o={color:a,hasAlpha:n,...r!==0||h!==0?{offsetX:r,offsetY:h}:{}};if(m===0){const S=i.readBEInt16At(u),P=i.readBEInt16At(u+2);return{type:"point",...o,x:S,y:P}}if(m&128){const S=i.readBEInt16At(u),P=i.readBEInt16At(u+2),I=i.readBEInt16At(u+4),M=i.readBEInt16At(u+6);return{type:"ellipse",...o,cx:S,cy:P,rx:I,ry:M}}let f=i.readBEInt16At(u),g=i.readBEInt16At(u+2);u+=4;const w=[[f,g]];for(let S=0;S<m;S++){const P=i.readInt8At(u),I=i.readInt8At(u+1);u+=2,f+=P,g+=I,w.push([f,g])}return{type:"polygon",...o,vertices:w}}class Lt{constructor(){p(this,"basePath","")}setBasePath(t){return this.basePath=t,this}load(t,e,s,a){const n=t.toUpperCase(),r=this.basePath+n+".CMD",h=this.basePath+n+".POL";let l=null,c=null,d=0;const m=()=>{if(l&&c)try{const o=this.parse(l,c,n);e(o)}catch(o){a?a(o):console.error("CutsceneLoader: Failed to parse cutscene:",o)}},u=()=>{if(d++,s){const o=new ProgressEvent("progress",{loaded:d,total:2,lengthComputable:!0});s(o)}};fetch(r).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return o.arrayBuffer()}).then(o=>{l=o,u(),m()}).catch(o=>{a?a(o):console.error(`CutsceneLoader: Failed to load ${r}:`,o)}),fetch(h).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);return o.arrayBuffer()}).then(o=>{c=o,u(),m()}).catch(o=>{a?a(o):console.error(`CutsceneLoader: Failed to load ${h}:`,o)})}loadAsync(t,e){return new Promise((s,a)=>{this.load(t,s,e,a)})}parse(t,e,s){const a=Mt(t),{shapes:n,palettes:r}=Ft(e);return{name:s,shapes:n,palettes:r,script:a}}}const Bt={[U.AUTO]:"Auto",[U.GENERIC]:"Generic (Linear)",[U.NATIVE_OPL3]:"Native OPL3",[U.DMX]:"DMX",[U.APOGEE]:"Apogee",[U.SB16_9X]:"SB16 9X",[U.DMX_FIXED]:"DMX Fixed",[U.APOGEE_FIXED]:"Apogee Fixed"},Ut=new Lt().setBasePath("/DATA/");async function Nt(i){return Ut.loadAsync(i)}document.addEventListener("DOMContentLoaded",async()=>{const i=document.getElementById("canvas-container"),t=document.getElementById("btn-prev"),e=document.getElementById("btn-play"),s=document.getElementById("btn-next"),a=document.getElementById("frame-info"),n=document.getElementById("audio-info"),r=document.getElementById("cutscene-select"),h=document.getElementById("channel-rows");if(!i||!t||!e||!s||!a||!r){console.error("Required DOM elements not found");return}const l=new It({container:i,displayScale:3,midiBasePath:"/DATA/",enableAudio:!0});l.onStateChange(o=>{a.textContent=`Frame: ${o.currentFrame+1} / ${o.totalFrames}`,e.textContent=o.isPlaying?"⏸ Pause":"▶ Play"}),l.onMidiStateChange(o=>{if(n)if(o.loaded){const f=m(o.position),g=m(o.duration);n.textContent=`OPL3: ${f} / ${g}`,n.classList.remove("no-audio"),n.classList.add("midi")}else n.textContent=o.error||"No audio",n.classList.add("no-audio"),n.classList.remove("midi")});let c=[];function d(o){var f;if(h){c=l.getAvailableInstruments(),h.innerHTML="";for(const g of o){if(!g.instrumentName)continue;const w=document.createElement("div");w.className="channel-row",g.muted&&w.classList.add("muted"),w.dataset.channel=String(g.channel);const S=document.createElement("input");S.type="checkbox",S.checked=!g.muted,S.title="Enable/disable channel",S.addEventListener("change",()=>{S.checked?l.unmuteChannel(g.channel):l.muteChannel(g.channel),w.classList.toggle("muted",!S.checked)});const P=document.createElement("span");P.className="ch-num",P.textContent=String(g.channel);const I=document.createElement("select");I.title="Change instrument";for(const F of c){const N=document.createElement("option");N.value=F,N.textContent=F,F.toLowerCase()===((f=g.instrumentName)==null?void 0:f.toLowerCase())&&(N.selected=!0),I.appendChild(N)}I.addEventListener("change",async()=>{await l.setChannelInstrument(g.channel,I.value)||(I.value=g.instrumentName||"")});const M=document.createElement("input");M.type="number",M.min="-4",M.max="4",M.value=String(g.octaveOffset||0),M.title="Octave offset",M.addEventListener("change",async()=>{const F=parseInt(M.value)||0;await l.setChannelOctaveOffset(g.channel,F)}),w.appendChild(S),w.appendChild(P),w.appendChild(I),w.appendChild(M),h.appendChild(w)}}}function m(o){if(!isFinite(o))return"0:00";const f=Math.floor(o/60),g=Math.floor(o%60);return`${f}:${g.toString().padStart(2,"0")}`}async function u(o){try{a.textContent="Loading...",n&&(n.textContent="Loading audio...",n.classList.add("no-audio"),n.classList.remove("midi"));const f=await Nt(o);let g=0;for(const S of f.script.subscenes)g+=S.frames.length;l.loadCutscene(f);const w=l.getState();w&&(a.textContent=`Frame: ${w.currentFrame+1} / ${w.totalFrames}`)}catch(f){console.error("Failed to load cutscene:",f),a.textContent="Failed to load cutscene data"}}await u(r.value),r.addEventListener("change",async()=>{l.stop(),await l.ensureAudioInitialized(),await u(r.value)}),t.addEventListener("click",()=>{l.prevFrame()}),e.addEventListener("click",async()=>{await l.ensureAudioInitialized();const o=await l.togglePlay();e.textContent=o?"⏸ Pause":"▶ Play"}),s.addEventListener("click",()=>{l.nextFrame()}),document.addEventListener("keydown",async o=>{switch(o.key){case"ArrowLeft":l.prevFrame();break;case"ArrowRight":l.nextFrame();break;case" ":o.preventDefault(),await l.ensureAudioInitialized(),await l.togglePlay();break;case"Home":l.reset();break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":{const f=parseInt(o.key);l.setVolumeModel(f),n&&(n.textContent=`Vol: ${Bt[f]}`);break}}}),l.onChannelChange(o=>{d(o)})});
